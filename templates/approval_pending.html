{% extends "base.html" %}

{% block page_title %}Pending Approvals{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-1">
                <i class="fas fa-clipboard-check me-2"></i>Pending Approvals
            </h3>
            <p class="text-muted mb-0">
                {% if session.role == 'store_manager' %}
                <span class="badge bg-warning-gradient fs-6 px-3 py-2">
                    <i class="fas fa-store me-1"></i>Store Manager
                </span>
                <span class="ms-2">You can approve gate passes for your store</span>
                {% else %}
                <span class="badge bg-info-gradient fs-6 px-3 py-2">
                    <i class="fas fa-user-tie me-1"></i>Department Head
                </span>
                <span class="ms-2">You can only approve users from your department</span>
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-light btn-lg border">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-primary border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-users fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Pending Users</h6>
                            <h2 class="text-white mb-0">{{ pending_users|length if pending_users else 0 }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-warning border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-passport fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Pending Gate Passes</h6>
                            <h2 class="text-white mb-0">{{ pending_passes|length if pending_passes else 0 }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-success border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-check-circle fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Ready to Approve</h6>
                            <h2 class="text-white mb-0">{{ (pending_users|length if pending_users else 0) + (pending_passes|length if pending_passes else 0) }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-info border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-clock fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Today</h6>
                            <h2 class="text-white mb-0">{{ now.strftime('%d %b') if now else '' }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-4">
        <!-- Pending Users Section (Only for Department Head) -->
        {% if session.role == 'department_head' %}
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0 text-dark">
                            <i class="fas fa-user-clock text-warning me-2"></i>
                            User Registration Requests
                        </h5>
                        {% if pending_users and pending_users|length > 0 %}
                        <span class="badge bg-warning rounded-pill px-3 py-2">
                            {{ pending_users|length }} pending
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if pending_users and pending_users|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">User Details</th>
                                    <th>Department</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in pending_users %}
                                <tr id="user-{{ user.id }}" class="user-row hover-lift">
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-primary-gradient me-3">
                                                <span class="avatar-text">{{ user.name[0]|upper }}</span>
                                            </div>
                                            <div>
                                                <h6 class="fw-bold mb-0">{{ user.name }}</h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-user me-1"></i>{{ user.username }}
                                                </small>
                                                <br>
                                                <small class="text-muted">
                                                    <i class="fas fa-briefcase me-1"></i>{{ user.designation }}
                                                </small>
                                                <br>
                                                <small class="text-success">
                                                    <i class="fas fa-calendar me-1"></i>{{ user.created_at.strftime('%d %b, %H:%M') }}
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="department-badge">
                                            <span class="badge bg-light text-dark border">
                                                <i class="fas fa-building me-1"></i>{{ user.department_name or 'No Department' }}
                                            </span>
                                            {% if user.division_name %}
                                            <br>
                                            <small class="text-muted mt-1 d-block">
                                                <i class="fas fa-sitemap me-1"></i>{{ user.division_name }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button onclick="approveUser({{ user.id }}, 'approve')" 
                                                    class="btn btn-success btn-sm rounded-start px-3 action-btn"
                                                    title="Approve User"
                                                    data-user="{{ user.id }}">
                                                <i class="fas fa-check me-1"></i>Approve
                                            </button>
                                            <button onclick="approveUser({{ user.id }}, 'reject')" 
                                                    class="btn btn-danger btn-sm rounded-end px-3 action-btn"
                                                    title="Reject User"
                                                    data-user="{{ user.id }}">
                                                <i class="fas fa-times me-1"></i>Reject
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="empty-state-icon mb-3">
                            <i class="fas fa-user-check fa-4x text-success opacity-25"></i>
                        </div>
                        <h5 class="fw-bold text-muted mb-2">No Pending Users</h5>
                        <p class="text-muted mb-0">All user registrations have been processed</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Pending Gate Passes Section (For Store Manager and Department Head) -->
        <div class="{% if session.role == 'department_head' %}col-lg-6{% else %}col-12{% endif %}">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0 text-dark">
                            <i class="fas fa-clipboard-list text-info me-2"></i>
                            Gate Pass Approvals
                        </h5>
                        {% if pending_passes and pending_passes|length > 0 %}
                        <span class="badge bg-info rounded-pill px-3 py-2">
                            {{ pending_passes|length }} pending
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if pending_passes and pending_passes|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Gate Pass Details</th>
                                    <th>Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pass in pending_passes %}
                                <tr id="gatepass-{{ pass.id }}" class="gatepass-row hover-lift">
                                    <td class="ps-4">
                                        <div>
                                            <h6 class="fw-bold mb-1 text-primary">
                                                <i class="fas fa-passport me-2"></i>{{ pass.pass_number }}
                                            </h6>
                                            <p class="mb-1 text-muted small">
                                                <i class="fas fa-user me-1"></i>Created by {{ pass.creator_name }}
                                            </p>
                                            <p class="mb-1 text-muted small">
                                                <i class="fas fa-box me-1"></i>{{ pass.material_description[:60] }}{% if pass.material_description|length > 60 %}...{% endif %}
                                            </p>
                                            <p class="mb-0 text-muted small">
                                                <i class="fas fa-building me-1"></i>{{ pass.department_name }}
                                            </p>
                                        </div>
                                    </td>
                                    <td>
                                        {% set status_colors = {
                                            'pending_dept': 'warning',
                                            'pending_store': 'info', 
                                            'pending_security': 'primary',
                                            'inquiry': 'secondary'
                                        } %}
                                        <span class="badge bg-{{ status_colors.get(pass.status, 'secondary') }}-gradient py-2 px-3">
                                            <i class="fas fa-{{ 'clock' if 'pending' in pass.status else 'question-circle' if pass.status == 'inquiry' else 'check' }} me-1"></i>
                                            {{ pass.status|replace('_', ' ')|title }}
                                        </span>
                                        <br>
                                        <small class="text-muted mt-1 d-block">
                                            <i class="fas fa-calendar me-1"></i>{{ pass.created_at.strftime('%d %b, %H:%M') }}
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('gate_pass.gate_pass_detail', gate_pass_id=pass.id) }}" 
                                               class="btn btn-outline-primary px-3"
                                               title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            {% if session.role == 'department_head' and pass.status == 'pending_dept' %}
                                            <button onclick="approveGatePassDirect({{ pass.id }}, 'approve')" 
                                                    class="btn btn-outline-success px-3"
                                                    title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="approveGatePassDirect({{ pass.id }}, 'reject')" 
                                                    class="btn btn-outline-danger px-3"
                                                    title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-warning px-3"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#inquiryModal"
                                                    onclick="setInquiryGatePassId({{ pass.id }})"
                                                    title="Mark for Inquiry">
                                                <i class="fas fa-question-circle"></i>
                                            </button>
                                            
                                            {% elif session.role == 'store_manager' and pass.status == 'pending_store' %}
                                            <button onclick="storeApproveGatePassDirect({{ pass.id }}, 'approve')" 
                                                    class="btn btn-outline-success px-3"
                                                    title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="storeApproveGatePassDirect({{ pass.id }}, 'reject')" 
                                                    class="btn btn-outline-danger px-3"
                                                    title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="empty-state-icon mb-3">
                            <i class="fas fa-check-circle fa-4x text-success opacity-25"></i>
                        </div>
                        <h5 class="fw-bold text-muted mb-2">No Pending Gate Passes</h5>
                        <p class="text-muted mb-0">All gate pass requests have been processed</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- For Store Managers: Additional Store Requests Section -->
    {% if session.role == 'store_manager' and store_requests and store_requests|length > 0 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-store me-2"></i>My Store Requests
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Request Details</th>
                                    <th>Status</th>
                                    <th>Urgency</th>
                                    <th>Admin Response</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in store_requests %}
                                <tr>
                                    <td class="ps-4">
                                        <h6 class="fw-bold mb-1">{{ request.material_description[:80] }}{% if request.material_description|length > 80 %}...{% endif %}</h6>
                                        <small class="text-muted">To: {{ request.destination }}</small>
                                        <br>
                                        <small class="text-muted">Purpose: {{ request.purpose[:60] }}</small>
                                    </td>
                                    <td>
                                        {% if request.status == 'pending' %}
                                        <span class="badge bg-warning py-2 px-3">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                        {% elif request.status == 'approved' %}
                                        <span class="badge bg-success py-2 px-3">
                                            <i class="fas fa-check me-1"></i>Approved
                                        </span>
                                        {% elif request.status == 'rejected' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-times me-1"></i>Rejected
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info py-2 px-3">
                                            <i class="fas fa-cog me-1"></i>Processing
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if request.urgency == 'urgent' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Urgent
                                        </span>
                                        {% elif request.urgency == 'emergency' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-skull-crossbones me-1"></i>Emergency
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary py-2 px-3">
                                            <i class="fas fa-check me-1"></i>Normal
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if request.admin_response %}
                                        <small class="text-muted">{{ request.admin_response[:80] }}</small>
                                        {% if request.admin_response|length > 80 %}...{% endif %}
                                        {% else %}
                                        <small class="text-muted">Waiting for response...</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ request.created_at.strftime('%d/%m/%Y') }}</small>
                                        <br>
                                        <small class="text-muted">{{ request.created_at.strftime('%I:%M %p') }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Legend Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="row g-3">
                        <div class="col-auto">
                            <span class="badge bg-success-gradient me-2 px-3 py-2">
                                <i class="fas fa-check me-1"></i>Approve
                            </span>
                            <small class="text-muted">Approve the request</small>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-danger-gradient me-2 px-3 py-2">
                                <i class="fas fa-times me-1"></i>Reject
                            </span>
                            <small class="text-muted">Reject the request</small>
                        </div>
                        {% if session.role == 'department_head' %}
                        <div class="col-auto">
                            <span class="badge bg-warning-gradient me-2 px-3 py-2">
                                <i class="fas fa-question-circle me-1"></i>Inquiry
                            </span>
                            <small class="text-muted">Mark for investigation</small>
                        </div>
                        {% endif %}
                        <div class="col-auto">
                            <span class="badge bg-primary-gradient me-2 px-3 py-2">
                                <i class="fas fa-eye me-1"></i>View
                            </span>
                            <small class="text-muted">View details</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comment Modal for Approve -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">
                    <i class="fas fa-check me-2"></i>Approve Gate Pass
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="approvalComment" class="form-label">
                        <i class="fas fa-sticky-note me-1"></i>Comment (Optional)
                    </label>
                    <textarea class="form-control" id="approvalComment" rows="4" 
                              placeholder="Add any comments or remarks about this approval (will be visible in details page but not in print)..."></textarea>
                    <div class="form-text">
                        This comment will be saved with the approval record but <strong>not printed</strong> on the gate pass.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="directApproveBtn">
                    <i class="fas fa-check me-1"></i>Approve
                </button>
                <button type="button" class="btn btn-primary" id="approveWithCommentBtn">
                    <i class="fas fa-check-circle me-1"></i>Approve with Comment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Additional Modal for Reject -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="fas fa-times me-2"></i>Reject Gate Pass
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectComment" class="form-label">
                        <i class="fas fa-sticky-note me-1"></i>Reason for Rejection (Optional)
                    </label>
                    <textarea class="form-control" id="rejectComment" rows="4" 
                              placeholder="Add reason for rejection..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="directRejectBtn">
                    <i class="fas fa-times me-1"></i>Reject
                </button>
                <button type="button" class="btn btn-warning" id="rejectWithCommentBtn">
                    <i class="fas fa-times-circle me-1"></i>Reject with Comment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Inquiry Modal -->
<div class="modal fade" id="inquiryModal" tabindex="-1" aria-labelledby="inquiryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inquiryModalLabel">
                    <i class="fas fa-question-circle me-2"></i>Mark for Inquiry
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inquiryForm">
                    <input type="hidden" id="inquiryGatePassId">
                    <div class="mb-3">
                        <label for="inquiryPurpose" class="form-label">
                            <i class="fas fa-comment-alt me-1"></i>Purpose of Inquiry
                        </label>
                        <textarea class="form-control" id="inquiryPurpose" rows="3" 
                                  placeholder="Explain why you are marking this for inquiry..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitInquiry()">
                    <i class="fas fa-paper-plane me-1"></i>Submit Inquiry
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3">
    <!-- Success Toast -->
    <div id="successToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <div id="toastMessage">Operation completed successfully!</div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <div id="errorMessage">An error occurred!</div>
        </div>
    </div>
</div>

<style>
/* Custom Styles */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
}

.stat-card {
    border-radius: 15px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
}

.bg-gradient-primary { background: var(--primary-gradient) !important; }
.bg-gradient-success { background: var(--success-gradient) !important; }
.bg-gradient-warning { background: var(--warning-gradient) !important; }
.bg-gradient-info { background: var(--info-gradient) !important; }
.bg-gradient-danger { background: var(--danger-gradient) !important; }

.stat-icon-container {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 18px;
}

.avatar-text {
    line-height: 1;
}

.hover-lift {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.user-row, .gatepass-row {
    border-left: 4px solid transparent;
}

.user-row:hover {
    border-left-color: #f7971e;
    background-color: rgba(247, 151, 30, 0.05);
}

.gatepass-row:hover {
    border-left-color: #4facfe;
    background-color: rgba(79, 172, 254, 0.05);
}

.action-btn {
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: scale(1.05);
}

.empty-state-icon {
    opacity: 0.5;
}

.table th {
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
    padding: 1rem;
}

.badge {
    font-weight: 500;
    letter-spacing: 0.3px;
}

.btn-group .btn {
    border-radius: 8px !important;
    margin: 2px;
}

.btn-group .btn:first-child {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}

.btn-group .btn:last-child {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
}

.card {
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.08);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px 12px 0 0 !important;
}

.toast {
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* ✅ INSTANT APPROVAL STYLES */
#commentModal .modal-content,
#rejectModal .modal-content {
    animation: modalSlideIn 0.2s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#commentModal textarea,
#rejectModal textarea {
    transition: all 0.2s;
}

#commentModal textarea:focus,
#rejectModal textarea:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.btn-instantly {
    transition: all 0.2s !important;
}

.btn-instantly:hover {
    transform: scale(1.02);
}

.btn-instantly:active {
    transform: scale(0.98);
}

/* Quick action animations */
@keyframes quickApprove {
    0% { background-color: #198754; }
    50% { background-color: #25b374; }
    100% { background-color: #198754; }
}

@keyframes quickReject {
    0% { background-color: #dc3545; }
    50% { background-color: #e4606d; }
    100% { background-color: #dc3545; }
}

.quick-approving {
    animation: quickApprove 0.5s ease infinite;
}

.quick-rejecting {
    animation: quickReject 0.5s ease infinite;
}

@media (max-width: 768px) {
    .stat-card .stat-icon-container {
        width: 50px;
        height: 50px;
    }
    
    .stat-card h2 {
        font-size: 1.5rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 8px !important;
        margin: 2px 0;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ✅ FIXED: GLOBAL APPROVAL STATE
let currentApprovalData = {
    passId: null,
    action: null,
    role: null
};

// ✅ FIXED: SIMPLE Department Head Approval - INSTANT
function approveGatePassDirect(passId, action) {
    currentApprovalData = { passId, action, role: 'department_head' };
    
    if (action === 'approve') {
        // Show approve modal immediately
        const modalElement = document.getElementById('commentModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Clear previous comment
        document.getElementById('approvalComment').value = '';
        
        // Setup event listeners for this specific modal instance
        setupApproveModalListeners(passId, 'department_head');
    } else {
        // Show reject modal immediately
        const modalElement = document.getElementById('rejectModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Clear previous comment
        document.getElementById('rejectComment').value = '';
        
        // Setup event listeners for this specific modal instance
        setupRejectModalListeners(passId, 'department_head');
    }
}

// ✅ FIXED: SIMPLE Store Manager Approval - INSTANT
function storeApproveGatePassDirect(passId, action) {
    currentApprovalData = { passId, action, role: 'store_manager' };
    
    if (action === 'approve') {
        // Show approve modal immediately
        const modalElement = document.getElementById('commentModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Clear previous comment
        document.getElementById('approvalComment').value = '';
        
        // Setup event listeners for this specific modal instance
        setupApproveModalListeners(passId, 'store_manager');
    } else {
        // Show reject modal immediately
        const modalElement = document.getElementById('rejectModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Clear previous comment
        document.getElementById('rejectComment').value = '';
        
        // Setup event listeners for this specific modal instance
        setupRejectModalListeners(passId, 'store_manager');
    }
}

// ✅ FIXED: SETUP APPROVE MODAL LISTENERS
function setupApproveModalListeners(passId, role) {
    // Clear previous listeners
    const clearAndSetupButton = (buttonId, handler) => {
        const button = document.getElementById(buttonId);
        if (!button) return;
        
        // Clone button to remove all existing event listeners
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Add fresh event listener
        document.getElementById(buttonId).addEventListener('click', handler);
    };
    
    // Setup direct approve button
    clearAndSetupButton('directApproveBtn', function() {
        processInstantApproval(passId, 'approve', role, '');
    });
    
    // Setup approve with comment button
    clearAndSetupButton('approveWithCommentBtn', function() {
        const comment = document.getElementById('approvalComment')?.value.trim() || '';
        processInstantApproval(passId, 'approve', role, comment);
    });
    
    // Setup cancel button
    clearAndSetupButton('cancelBtn', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('commentModal'));
        if (modal) modal.hide();
    });
}

// ✅ FIXED: SETUP REJECT MODAL LISTENERS
function setupRejectModalListeners(passId, role) {
    // Clear previous listeners
    const clearAndSetupButton = (buttonId, handler) => {
        const button = document.getElementById(buttonId);
        if (!button) return;
        
        // Clone button to remove all existing event listeners
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Add fresh event listener
        document.getElementById(buttonId).addEventListener('click', handler);
    };
    
    // Setup direct reject button
    clearAndSetupButton('directRejectBtn', function() {
        processInstantApproval(passId, 'reject', role, '');
    });
    
    // Setup reject with comment button
    clearAndSetupButton('rejectWithCommentBtn', function() {
        const comment = document.getElementById('rejectComment')?.value.trim() || '';
        processInstantApproval(passId, 'reject', role, comment);
    });
}

// ✅ FIXED: INSTANT APPROVAL PROCESSING - ULTRA FAST
function processInstantApproval(passId, action, role, comment = '') {
    // Close modal IMMEDIATELY
    if (action === 'approve') {
        const approveModal = bootstrap.Modal.getInstance(document.getElementById('commentModal'));
        if (approveModal) approveModal.hide();
    } else {
        const rejectModal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
        if (rejectModal) rejectModal.hide();
    }
    
    // Show immediate feedback
    showToast(`Processing ${action}...`, 'info');
    
    // Get the row element for animation
    const row = document.getElementById(`gatepass-${passId}`);
    if (row) {
        row.style.transition = 'all 0.3s ease';
        row.style.opacity = '0.5';
        row.style.backgroundColor = action === 'approve' ? 'rgba(25, 135, 84, 0.1)' : 'rgba(220, 53, 69, 0.1)';
    }
    
    // Determine endpoint
    let endpoint = '';
    if (role === 'department_head' || role === 'store_manager') {
        endpoint = `/gate_pass/approve_gate_pass_with_comment/${passId}/${action}`;
    }
    
    // Send request IMMEDIATELY with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
    
    fetch(endpoint, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ comment: comment }),
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success immediately
            showToast(`✅ ${data.message}`, 'success');
            
            // Remove row with animation
            if (row) {
                row.style.transform = 'translateX(-100%)';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    updateStatsCount();
                    
                    // Check if table is empty
                    const tableBody = document.querySelector('.card:nth-child(2) tbody');
                    if (tableBody && tableBody.children.length === 0) {
                        showEmptyState('gatepasses');
                    }
                }, 300);
            }
            
            // Auto-refresh page after 1.5 seconds
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast(`❌ ${data.message}`, 'error');
            // Reset row style on error
            if (row) {
                row.style.opacity = '1';
                row.style.backgroundColor = '';
            }
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('Error:', error);
        showToast('Network error. Please try again.', 'error');
        // Reset row style on error
        if (row) {
            row.style.opacity = '1';
            row.style.backgroundColor = '';
        }
    });
}

// ✅ Handle user approval
function approveUser(userId, action) {
    const actionText = action === 'approve' ? 'Approve' : 'Reject';
    const icon = action === 'approve' ? '✅' : '❌';
    
    if (!confirm(`${icon} Are you sure you want to ${actionText} this user?`)) {
        return;
    }
    
    const button = document.querySelector(`button[data-user="${userId}"]`);
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    fetch(`/approve_user/${userId}/${action}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message || `User ${actionText.toLowerCase()}d successfully!`, 'success');
                // Remove the user row from table
                const userRow = document.getElementById(`user-${userId}`);
                if (userRow) {
                    userRow.remove();
                }
                // Update stats count
                updateStatsCount();
            } else {
                showToast(data.message || `Error ${actionText.toLowerCase()}ing user`, 'error');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

// Department Head: Inquiry
let currentInquiryGatePassId = null;

function setInquiryGatePassId(passId) {
    currentInquiryGatePassId = passId;
    document.getElementById('inquiryPurpose').value = '';
}

function submitInquiry() {
    const inquiryPurpose = document.getElementById('inquiryPurpose').value.trim();
    
    if (!inquiryPurpose) {
        showToast('Please enter inquiry purpose', 'error');
        return;
    }
    
    if (!currentInquiryGatePassId) {
        showToast('Gate pass ID not set', 'error');
        return;
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('inquiryModal'));
    modal.hide();
    
    showLoading('Submitting inquiry...');
    
    fetch(`/gate_pass/approve_gate_pass/${currentInquiryGatePassId}/inquiry?inquiry_purpose=${encodeURIComponent(inquiryPurpose)}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Gate pass marked for inquiry!', 'success');
            
            // Remove row with animation
            const gatepassRow = document.getElementById(`gatepass-${currentInquiryGatePassId}`);
            if (gatepassRow) {
                gatepassRow.style.transition = 'all 0.3s ease';
                gatepassRow.style.transform = 'translateX(100%)';
                gatepassRow.style.opacity = '0';
                
                setTimeout(() => {
                    gatepassRow.remove();
                    updateStatsCount();
                    
                    // Check if table is empty
                    const tableBody = document.querySelector('.card:nth-child(2) tbody');
                    if (tableBody && tableBody.children.length === 0) {
                        showEmptyState('gatepasses');
                    }
                    
                    // Auto refresh the page
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }, 300);
            } else {
                // If row not found, just refresh page
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            showToast(data.message || 'Error marking for inquiry', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
    });
}

// Toast notification function
function showToast(message, type = 'success') {
    let toastElement, toastMessage;
    
    if (type === 'error') {
        toastElement = document.getElementById('errorToast');
        toastMessage = document.getElementById('errorMessage');
    } else {
        toastElement = document.getElementById('successToast');
        toastMessage = document.getElementById('toastMessage');
    }
    
    if (!toastElement || !toastMessage) {
        console.error('Toast elements not found');
        // Fallback alert
        alert(message);
        return;
    }
    
    // Update message and timestamp
    toastMessage.textContent = message;
    const timeElement = toastElement.querySelector('small');
    if (timeElement) {
        const now = new Date();
        timeElement.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    // Show toast
    const bsToast = new bootstrap.Toast(toastElement);
    bsToast.show();
}

// Update stats count after approval
function updateStatsCount() {
    // Get current counts
    const userRows = document.querySelectorAll('.user-row');
    const gatepassRows = document.querySelectorAll('.gatepass-row');
    
    // Update pending users count
    const pendingUsersElement = document.querySelector('.stat-card:nth-child(1) h2');
    if (pendingUsersElement) {
        pendingUsersElement.textContent = userRows.length;
    }
    
    // Update pending gate passes count
    const pendingPassesElement = document.querySelector('.stat-card:nth-child(2) h2');
    if (pendingPassesElement) {
        pendingPassesElement.textContent = gatepassRows.length;
    }
    
    // Update ready to approve count
    const readyToApproveElement = document.querySelector('.stat-card:nth-child(3) h2');
    if (readyToApproveElement) {
        readyToApproveElement.textContent = userRows.length + gatepassRows.length;
    }
    
    // Update badges
    const userBadge = document.querySelector('.card:nth-child(1) .badge.bg-warning');
    if (userBadge) {
        userBadge.textContent = `${userRows.length} pending`;
    }
    
    const passBadge = document.querySelector('.card:nth-child(2) .badge.bg-info');
    if (passBadge) {
        passBadge.textContent = `${gatepassRows.length} pending`;
    }
    
    // If no pending items, show empty state
    if (userRows.length === 0) {
        showEmptyState('users');
    }
    if (gatepassRows.length === 0) {
        showEmptyState('gatepasses');
    }
}

function showEmptyState(type) {
    const cardBody = document.querySelector(`.card:nth-child(${type === 'users' ? 1 : 2}) .card-body`);
    if (cardBody && !cardBody.querySelector('.empty-state-icon')) {
        cardBody.innerHTML = `
            <div class="text-center py-5">
                <div class="empty-state-icon mb-3">
                    <i class="fas fa-${type === 'users' ? 'user-check' : 'check-circle'} fa-4x text-success opacity-25"></i>
                </div>
                <h5 class="fw-bold text-muted mb-2">No Pending ${type === 'users' ? 'Users' : 'Gate Passes'}</h5>
                <p class="text-muted mb-0">All ${type === 'users' ? 'user registrations' : 'gate pass requests'} have been processed</p>
            </div>
        `;
    }
}

// ✅ FIXED: Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Clear modals on hide
    const commentModal = document.getElementById('commentModal');
    const rejectModal = document.getElementById('rejectModal');
    
    if (commentModal) {
        commentModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('approvalComment').value = '';
        });
    }
    
    if (rejectModal) {
        rejectModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('rejectComment').value = '';
        });
    }
    
    // Add animation to table rows
    const rows = document.querySelectorAll('.user-row, .gatepass-row');
    rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            row.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Auto-hide toasts after 5 seconds
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(toast => {
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    });
});

// Helper function for loading state
function showLoading(message) {
    console.log('Loading:', message);
}
</script>
{% endblock %}