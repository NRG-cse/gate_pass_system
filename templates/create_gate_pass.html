{% extends "base.html" %}

{% block page_title %}Create New Gate Pass{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Progress Steps -->
    <div class="card border-0 shadow mb-4">
        <div class="card-body">
            <div class="steps">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-label">Material Info</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-label">Transfer Details</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label">Photos</div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-label">Review & Submit</div>
                </div>
            </div>
        </div>
    </div>

    <form id="gatePassForm" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-6">
                <!-- Material Information -->
                <div class="card border-0 shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-box-open me-2"></i>Material Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Division/Department *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-building"></i></span>
                                    <input type="text" class="form-control form-control-lg" 
                                           name="division_department" required
                                           placeholder="e.g., Production, IT, HR">
                                    <div class="invalid-feedback">
                                        Please enter department name.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Material Description *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                    <textarea class="form-control form-control-lg" 
                                              name="material_description" rows="3" required
                                              placeholder="Describe the material in detail"></textarea>
                                    <div class="invalid-feedback">
                                        Please describe the material.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Material Type *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                    <select class="form-select form-control-lg" name="material_type" id="materialType" required>
                                        <option value="">Select Type</option>
                                        <option value="returnable">Returnable</option>
                                        <option value="non_returnable">Non-Returnable</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select material type.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Material Status *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                                    <select class="form-select form-control-lg" name="material_status" required>
                                        <option value="">Select Status</option>
                                        <option value="damaged">Damaged/Lost</option>
                                        <option value="repair">For Repair</option>
                                        <option value="new">New Material</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select material status.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12" id="returnDateField" style="display: none;">
                                <label class="form-label">Expected Return Date *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    <input type="datetime-local" class="form-control form-control-lg" 
                                           name="expected_return_date" id="expectedReturnDate">
                                    <div class="invalid-feedback">
                                        Please select expected return date.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transfer Information -->
                <div class="card border-0 shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Transfer Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Destination *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <input type="text" class="form-control form-control-lg" 
                                           name="destination" required
                                           placeholder="Where is the material going?">
                                    <div class="invalid-feedback">
                                        Please enter destination.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Purpose *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-bullseye"></i></span>
                                    <textarea class="form-control form-control-lg" 
                                              name="purpose" rows="2" required
                                              placeholder="Purpose of sending the material"></textarea>
                                    <div class="invalid-feedback">
                                        Please enter purpose.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Send Date *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar-check"></i></span>
                                    <input type="datetime-local" class="form-control form-control-lg" 
                                           name="send_date" required>
                                    <div class="invalid-feedback">
                                        Please select send date.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Vehicle Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-car"></i></span>
                                    <input type="text" class="form-control form-control-lg" 
                                           name="vehicle_number"
                                           placeholder="Optional">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="col-lg-6">
                <!-- Receiver Information -->
                <div class="card border-0 shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Receiver Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Receiver Name *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control form-control-lg" 
                                           name="receiver_name" required
                                           placeholder="Name of person receiving the material">
                                    <div class="invalid-feedback">
                                        Please enter receiver name.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Receiver Contact</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    <input type="tel" class="form-control form-control-lg" 
                                           name="receiver_contact"
                                           placeholder="Phone number" pattern="[0-9]{3}-[0-9]{2}-[0-9]{3}" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Receiver ID</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                    <input type="text" class="form-control form-control-lg" 
                                           name="receiver_id"
                                           placeholder="Employee/Visitor ID">
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Delivery Address</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-home"></i></span>
                                    <textarea class="form-control form-control-lg" 
                                              name="delivery_address" rows="2"
                                              placeholder="Full delivery address (if different)"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Photo Capture Section -->
                <div class="card border-0 shadow mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-camera me-2"></i>Material Photos (Required: 4 Photos)</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> System will automatically capture 4 photos (front, back, left, right) 
                            with 3-second intervals. Make sure material is properly placed.
                        </div>
                        
                        <div class="text-center mb-4">
                            <button type="button" class="btn btn-success btn-lg px-5" id="startCamera">
                                <i class="fas fa-camera me-2"></i>Start Camera & Capture Photos
                            </button>
                            <button type="button" class="btn btn-warning btn-lg px-5" id="stopCamera" style="display: none;">
                                <i class="fas fa-stop me-2"></i>Stop Camera
                            </button>
                        </div>
                        
                        <div id="cameraSection" style="display: none;">
                            <div class="text-center mb-4">
                                <video id="video" autoplay playsinline class="img-fluid rounded camera-preview"></video>
                                <canvas id="canvas" style="display: none;"></canvas>
                            </div>
                            
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="photoProgress" style="width: 0%"></div>
                            </div>
                            <p class="text-center mb-0" id="photoStatus">Ready to capture photos...</p>
                            
                            <div class="mt-4">
                                <h6>Captured Photos Preview:</h6>
                                <div class="row g-2" id="capturedPhotos">
                                    <!-- Photos will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Information -->
                <div class="card border-0 shadow mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Additional Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Special Instructions</label>
                                <textarea class="form-control form-control-lg" 
                                          name="special_instructions" rows="2"
                                          placeholder="Any special handling instructions"></textarea>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           name="urgent" id="urgentCheck" value="true">
                                    <label class="form-check-label" for="urgentCheck">
                                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                        Mark as Urgent Delivery
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="terms" id="termsCheck" required>
                                    <label class="form-check-label" for="termsCheck">
                                        I confirm that all information provided is accurate
                                    </label>
                                    <div class="invalid-feedback">
                                        You must agree before submitting.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Submit Buttons -->
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5 py-3">
                <i class="fas fa-paper-plane me-2"></i>Submit Gate Pass
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-lg px-5 py-3 ms-3">
                <i class="fas fa-times me-2"></i>Cancel
            </a>
        </div>
    </form>
</div>

<!-- Camera Script -->
<script>
// Form Validation
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
})()

// Material Type Change Handler
const materialType = document.getElementById('materialType');
const returnDateField = document.getElementById('returnDateField');
const returnDateInput = document.getElementById('expectedReturnDate');

materialType.addEventListener('change', function() {
    if (this.value === 'returnable') {
        returnDateField.style.display = 'block';
        returnDateInput.required = true;
    } else {
        returnDateField.style.display = 'none';
        returnDateInput.required = false;
    }
});

// Camera Functionality
let stream = null;
let photoCount = 0;
const maxPhotos = 4;
let captureInterval = null;

document.getElementById('startCamera').addEventListener('click', startCamera);
document.getElementById('stopCamera').addEventListener('click', stopCamera);

async function startCamera() {
    try {
        // Check camera permissions
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        // Show camera section
        document.getElementById('cameraSection').style.display = 'block';
        document.getElementById('startCamera').style.display = 'none';
        document.getElementById('stopCamera').style.display = 'inline-block';
        
        // Reset photo count
        photoCount = 0;
        document.getElementById('capturedPhotos').innerHTML = '';
        updateProgress(0);
        
        // Start capturing photos
        captureInterval = setInterval(capturePhoto, 3000);
        
    } catch (err) {
        alert('Error accessing camera: ' + err.message);
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    if (captureInterval) {
        clearInterval(captureInterval);
    }
    
    document.getElementById('cameraSection').style.display = 'none';
    document.getElementById('startCamera').style.display = 'inline-block';
    document.getElementById('stopCamera').style.display = 'none';
}

function capturePhoto() {
    if (photoCount >= maxPhotos) {
        clearInterval(captureInterval);
        document.getElementById('stopCamera').style.display = 'none';
        document.getElementById('photoStatus').textContent = 'All photos captured!';
        return;
    }
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    // Set canvas size
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert to data URL
    const photoData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Display photo
    displayCapturedPhoto(photoData, photoCount + 1);
    
    // Add to form
    addPhotoToForm(photoData);
    
    // Update progress
    photoCount++;
    updateProgress((photoCount / maxPhotos) * 100);
    document.getElementById('photoStatus').textContent = `Captured ${photoCount} of ${maxPhotos} photos`;
    
    if (photoCount >= maxPhotos) {
        clearInterval(captureInterval);
        document.getElementById('stopCamera').style.display = 'none';
        document.getElementById('photoStatus').textContent = 'All photos captured successfully!';
        
        // Show success message
        showToast('âœ… All 4 photos captured successfully!', 'success');
    }
}

function displayCapturedPhoto(photoData, number) {
    const photosContainer = document.getElementById('capturedPhotos');
    
    const photoCol = document.createElement('div');
    photoCol.className = 'col-md-3 col-6';
    photoCol.innerHTML = `
        <div class="photo-item">
            <img src="${photoData}" alt="Photo ${number}">
            <div class="photo-number">${number}</div>
        </div>
    `;
    
    photosContainer.appendChild(photoCol);
}

function addPhotoToForm(photoData) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'captured_images[]';
    input.value = photoData;
    
    document.getElementById('gatePassForm').appendChild(input);
}

function updateProgress(percent) {
    document.getElementById('photoProgress').style.width = percent + '%';
}

// Toast Notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                    onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    const container = document.getElementById('toastContainer') || createToastContainer();
    container.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// Auto-fill today's date for send date
window.addEventListener('load', function() {
    const now = new Date();
    const timezoneOffset = now.getTimezoneOffset() * 60000;
    const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
    
    const sendDateInput = document.querySelector('input[name="send_date"]');
    if (sendDateInput && !sendDateInput.value) {
        sendDateInput.value = localISOTime;
    }
    
    // Set return date to tomorrow by default
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowISOTime = new Date(tomorrow - timezoneOffset).toISOString().slice(0, 16);
    
    const returnDateInput = document.getElementById('expectedReturnDate');
    if (returnDateInput) {
        returnDateInput.value = tomorrowISOTime;
        returnDateInput.min = localISOTime;
    }
});
</script>

<style>
/* Steps Progress */
.steps {
    display: flex;
    justify-content: space-between;
    margin: 0 auto;
    max-width: 800px;
}

.step {
    text-align: center;
    position: relative;
    flex: 1;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 25px;
    left: 60%;
    width: 80%;
    height: 3px;
    background: #e0e0e0;
    z-index: 1;
}

.step.active:not(:last-child)::after {
    background: var(--primary);
}

.step-number {
    width: 50px;
    height: 50px;
    background: #e0e0e0;
    color: #666;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 0 auto 10px;
    position: relative;
    z-index: 2;
}

.step.active .step-number {
    background: var(--primary);
    color: white;
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
}

.step-label {
    font-weight: 500;
    color: #666;
}

.step.active .step-label {
    color: var(--primary);
    font-weight: 600;
}

/* Form validation styling */
.was-validated .form-control:valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
}

.was-validated .form-control:invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
}
</style>
{% endblock %}