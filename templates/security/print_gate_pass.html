{% extends "base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Gate Pass - {{ gate_pass.pass_number }}</title>
    <style>
        /* COMPACT PRINT STYLES */
        @media print {
            body {
                font-family: 'Arial', sans-serif;
                font-size: 9pt !important;
                line-height: 1.2;
                margin: 0;
                padding: 0;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-container {
                width: 190mm;
                min-height: 277mm;
                max-height: 277mm;
                margin: 0 auto;
                padding: 10mm;
                position: relative;
                page-break-inside: avoid;
            }
            
            /* Two Column Layout for Print */
            .two-column-layout {
                display: flex;
                width: 100%;
                gap: 5mm;
                margin-bottom: 3mm;
            }
            
            .left-column {
                width: 70%;
                flex: 0 0 70%;
            }
            
            .right-column {
                width: 30%;
                flex: 0 0 30%;
                border-left: 1px solid #ccc;
                padding-left: 3mm;
            }
            
            /* Compact Header */
            .compact-header {
                display: flex;
                align-items: flex-start;
                margin-bottom: 5mm;
                padding-bottom: 3mm;
                border-bottom: 1.5px solid #000;
            }
            
            .logo-section {
                width: 25mm;
                height: 25mm;
                border: 1px solid #ccc;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                margin-right: 5mm;
                flex-shrink: 0;
            }
            
            .company-info {
                flex-grow: 1;
            }
            
            .company-name {
                font-size: 16pt;
                font-weight: bold;
                margin-bottom: 1mm;
                color: #000;
            }
            
            .company-address {
                font-size: 8pt;
                color: #555;
                margin-bottom: 0.5mm;
                line-height: 1.2;
            }
            
            .gate-pass-title {
                text-align: right;
                font-size: 14pt;
                font-weight: bold;
                color: #000;
                margin-bottom: 1mm;
            }
            
            .gate-pass-number {
                font-size: 12pt;
                font-weight: bold;
                text-align: right;
                color: #333;
            }
            
            /* Compact Card Styles */
            .compact-card {
                border: 1px solid #000;
                margin-bottom: 3mm;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .compact-card-header {
                background: #f0f0f0;
                padding: 2mm 3mm;
                border-bottom: 1px solid #000;
                font-weight: bold;
                font-size: 9pt;
            }
            
            .compact-card-body {
                padding: 2mm 3mm;
            }
            
            /* Compact Table */
            .compact-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 8pt;
            }
            
            .compact-table td {
                padding: 0.5mm 1mm;
                vertical-align: top;
                line-height: 1.2;
            }
            
            .compact-table .label {
                font-weight: bold;
                width: 35%;
                color: #333;
            }
            
            .compact-table .value {
                width: 65%;
                word-break: break-word;
            }
            
            /* Compact QR Code */
            .compact-qr-container {
                text-align: center;
                margin-bottom: 3mm;
            }
            
            .compact-qr-image {
                width: 40mm;
                height: 40mm;
                border: 1px solid #ccc;
                padding: 1mm;
                background: white;
                margin: 0 auto;
            }
            
            .compact-qr-text {
                font-size: 7pt;
                color: #666;
                margin-top: 1mm;
                word-break: break-all;
            }
            
            /* Status Badges */
            .status-badge {
                display: inline-block;
                padding: 1px 4px;
                font-size: 7pt;
                border: 1px solid #ccc;
                margin: 0 1px 1px 0;
                border-radius: 2px;
            }
            
            .status-approved {
                background: #e8f5e9;
                color: #2e7d32;
            }
            
            .status-pending {
                background: #fff3e0;
                color: #f57c00;
            }
            
            .status-rejected {
                background: #ffebee;
                color: #c62828;
            }
            
            /* Approval Grid */
            .approval-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 2mm;
                margin-top: 2mm;
                font-size: 7pt;
            }
            
            .approval-item {
                text-align: center;
                padding: 1mm;
                border: 1px solid #ccc;
                border-radius: 2px;
            }
            
            /* Footer */
            .compact-footer {
                margin-top: 3mm;
                padding-top: 2mm;
                border-top: 1px solid #000;
                font-size: 7pt;
                color: #666;
            }
            
            /* Prevent page breaks */
            .page-break-avoid {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            /* Ensure single page */
            html, body {
                width: 210mm;
                height: 297mm;
                overflow: hidden;
            }
            
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
            
            /* Security Stamp */
            .security-stamp {
                position: absolute;
                top: 15mm;
                right: 15mm;
                transform: rotate(15deg);
                border: 2px solid #d32f2f;
                padding: 3mm 5mm;
                background: rgba(255, 255, 255, 0.9);
                font-weight: bold;
                color: #d32f2f;
                font-size: 10pt;
                z-index: 100;
                box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            }
            
            /* Signature Section */
            .signature-section {
                margin-top: 5mm;
                padding-top: 2mm;
                border-top: 1px solid #000;
            }
            
            .signature-row {
                display: flex;
                justify-content: space-between;
                margin-top: 3mm;
            }
            
            .signature-box {
                width: 45%;
                text-align: center;
            }
            
            .signature-line {
                width: 80%;
                height: 1px;
                background: #000;
                margin: 15mm auto 2mm auto;
            }
            
            .signature-text {
                font-size: 8pt;
                font-weight: bold;
            }
            
            .signature-designation {
                font-size: 7pt;
                color: #666;
            }
            
            /* Material Images */
            .compact-images {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 1mm;
                margin-top: 1mm;
            }
            
            .compact-image {
                width: 100%;
                height: 15mm;
                object-fit: cover;
                border: 1px solid #ccc;
                border-radius: 1px;
            }
            
            /* Important Notes */
            .important-notes {
                background: #fff8e1;
                border: 1px solid #ffd54f;
                padding: 2mm;
                margin: 2mm 0;
                font-size: 7pt;
                line-height: 1.3;
            }

            /* Security Copy Badge */
            .security-copy-badge {
                position: absolute;
                top: 5mm;
                right: 5mm;
                background: #d32f2f;
                color: white;
                padding: 2mm 4mm;
                font-weight: bold;
                font-size: 10pt;
                border-radius: 3px;
                z-index: 50;
            }
        }
        
        /* WEB VIEW STYLES */
        @media screen {
            body {
                background: #f8f9fa;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                padding-bottom: 20px;
            }
            
            .print-container {
                display: none;
            }
            
            .no-print {
                display: block;
            }
            
            .preview-container {
                max-width: 210mm;
                margin: 20px auto;
                background: white;
                padding: 20px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border-radius: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Web Interface -->
    <div class="no-print">
        <div class="container-fluid p-0 h-100">
            <div class="row g-0 h-100">
                <div class="col-12 h-100">
                    <div class="card h-100 m-0 border-0">
                        <!-- Security Approval Header -->
                        <div class="card-header bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0">
                                        <i class="fas fa-shield-alt"></i> 
                                        SECURITY GATE PASS PRINTING
                                    </h4>
                                    <p class="mb-0">
                                        Gate Pass: {{ gate_pass.pass_number }} | Approved by: {{ security_name }}
                                    </p>
                                </div>
                                <div>
                                    <span class="badge bg-light text-dark fs-6 px-3 py-2">
                                        <i class="fas fa-print"></i> READY TO PRINT
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-4">
                            <!-- Print Confirmation -->
                            <div class="text-center mb-5">
                                <div class="display-1 text-success mb-3">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h2 class="fw-bold mb-3">SECURITY APPROVED ‚úì</h2>
                                <div class="alert alert-success fs-5">
                                    <i class="fas fa-check-double"></i>
                                    All approvals completed. Gate pass is ready for printing.
                                </div>
                            </div>

                            <!-- Print Controls -->
                            <div class="text-center mb-4">
                                <button onclick="startPrintProcess()" class="btn btn-primary btn-lg px-5 py-3 fs-3">
                                    <i class="fas fa-print me-3"></i> PRINT SECURITY COPY
                                </button>
                                <a href="{{ url_for('gate_pass.gate_pass_list') }}" class="btn btn-secondary btn-lg ms-3 px-4 py-3 fs-5">
                                    <i class="fas fa-arrow-left me-2"></i> Back to List
                                </a>
                                
                                <p class="text-muted mt-3">
                                    <i class="fas fa-info-circle"></i>
                                    After printing, material can leave the gate
                                </p>
                            </div>
                            
                            <!-- IMPORTANT: Print Instructions -->
                            <div class="alert alert-warning">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                    <div>
                                        <h5 class="mb-1">üìã IMPORTANT PRINTING INSTRUCTIONS:</h5>
                                        <p class="mb-0">
                                            <strong>Please print 2 copies:</strong><br>
                                            1. <strong>SECURITY OFFICE COPY</strong> (Keep for records)<br>
                                            2. <strong>RECEIVER COPY</strong> (Give to receiver with material)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Print Preview -->
                            <div class="preview-container mt-5">
                                <h5 class="fw-bold mb-3 text-center">Print Preview (Single Page):</h5>
                                <div class="text-center mb-3">
                                    <small class="text-muted">This is how the printed copy will look</small>
                                </div>
                                
                                <!-- Preview of actual print layout -->
                                <div style="border: 2px dashed #ccc; padding: 10px; background: #f9f9f9;">
                                    <div class="compact-header">
                                        <div class="logo-section">
                                            <i class="fas fa-building fa-2x text-muted"></i>
                                            <div style="font-size: 8px; margin-top: 2px;">NR GROUP</div>
                                        </div>
                                        <div class="company-info">
                                            <div class="company-name">NR GROUP</div>
                                            <div class="company-address">
                                                Square Masterbari, Jamirdia, Bhaluka, Mymensingh<br>
                                                One stop solution for sustainable textile
                                            </div>
                                        </div>
                                        <div>
                                            <div class="gate-pass-title">GATE PASS</div>
                                            <div class="gate-pass-number">{{ gate_pass.pass_number }}</div>
                                            <div style="font-size: 9px; color: #666;">
                                                Created: {{ gate_pass.created_at.strftime('%d/%m/%Y %H:%M') }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="two-column-layout">
                                        <div class="left-column">
                                            <!-- Preview content here -->
                                            <div style="font-size: 10px; color: #666; padding: 5px;">
                                                <strong>Material:</strong> {{ gate_pass.material_description|truncate(100) }}<br>
                                                <strong>Destination:</strong> {{ gate_pass.destination }}<br>
                                                <strong>Receiver:</strong> {{ gate_pass.receiver_name }}
                                            </div>
                                        </div>
                                        <div class="right-column">
                                            <div style="text-align: center; padding: 5px;">
                                                <div style="width: 60px; height: 60px; background: #eee; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                                                    QR
                                                </div>
                                                <div style="font-size: 8px; margin-top: 2px;">Verification Code</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Security Signature Preview -->
                                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <div style="width: 45%;">
                                                <div style="font-size: 9px; font-weight: bold;">Receiver Signature & Stamp</div>
                                                <div style="width: 80%; height: 1px; background: #000; margin: 25px 0 5px 0;"></div>
                                                <div style="font-size: 8px;">Name: {{ gate_pass.receiver_name }}</div>
                                                <div style="font-size: 8px;">Date: __________________</div>
                                            </div>
                                            <div style="width: 45%; text-align: right;">
                                                <div style="font-size: 9px; font-weight: bold;">Security Signature & Seal</div>
                                                <div style="width: 80%; height: 1px; background: #000; margin: 25px 0 5px 0; margin-left: auto;"></div>
                                                <div style="font-size: 8px;">Name: {{ security_name }}</div>
                                                <div style="font-size: 8px;">Date: {{ now.strftime('%d/%m/%Y') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 9px; color: #888; text-align: center; padding: 10px; border-top: 1px dashed #ccc; margin-top: 10px;">
                                        This is a preview. Actual print will be more detailed and compact.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> Printing will notify all parties including creator, department head, store manager, and system admins.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT AREA (Hidden in web view) -->
    <div class="print-container">
        <!-- Security Copy Badge -->
        <div class="security-copy-badge">
            SECURITY OFFICE COPY
        </div>

        <!-- Security Stamp -->
        <div class="security-stamp">
            SECURITY COPY<br>
            {{ now.strftime('%d/%m/%Y') }}
        </div>

        <!-- Compact Header -->
        <div class="compact-header page-break-avoid">
            <!-- Company Logo -->
            <div class="logo-section">
                <!-- Replace with actual logo -->
                <!-- <img src="{{ url_for('static', filename='images/logo.png') }}" style="max-width: 100%; max-height: 100%;"> -->
                <i class="fas fa-building" style="font-size: 16pt;"></i>
                <div style="font-size: 7pt; margin-top: 1mm; text-align: center;">NR GROUP</div>
            </div>
            
            <!-- Company Info -->
            <div class="company-info">
                <div class="company-name">NR GROUP</div>
                <div class="company-address">
                    Square Masterbari, Jamirdia, Bhaluka, Mymensingh<br>
                    Quality Textiles Manufacturer & Exporter<br>
                    Tel: +880 XXX XXXXXXX | Email: info@nrgroup.com
                </div>
            </div>
            
            <!-- Gate Pass Info -->
            <div>
                <div class="gate-pass-title">GATE PASS</div>
                <div class="gate-pass-number">{{ gate_pass.pass_number }}</div>
                <div style="font-size: 8pt; color: #555; text-align: right;">
                    Created: {{ gate_pass.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
                    Printed: {{ now.strftime('%d/%m/%Y %H:%M') }}
                </div>
            </div>
        </div>

        <!-- Status Badges -->
        <div style="margin-bottom: 3mm; text-align: center;">
            <span class="status-badge status-{{ gate_pass.department_approval }}">
                Dept: {{ gate_pass.department_approval|upper }}
            </span>
            <span class="status-badge status-{{ gate_pass.store_approval }}">
                Store: {{ gate_pass.store_approval|upper }}
            </span>
            <span class="status-badge status-{{ gate_pass.security_approval }}">
                Security: {{ gate_pass.security_approval|upper }}
            </span>
            <span class="status-badge status-{{ gate_pass.status }}">
                Status: {{ gate_pass.status|upper|replace('_', ' ') }}
            </span>
            {% if gate_pass.material_type == 'returnable' %}
            <span class="status-badge" style="background: #e3f2fd; color: #1565c0;">
                Returnable
            </span>
            {% endif %}
        </div>

        <!-- Main Two Column Layout -->
        <div class="two-column-layout page-break-avoid">
            <!-- Left Column: Details -->
            <div class="left-column">
                <!-- Material Information -->
                <div class="compact-card">
                    <div class="compact-card-header">
                        MATERIAL INFORMATION
                    </div>
                    <div class="compact-card-body">
                        <table class="compact-table">
                            <tr>
                                <td class="label">Description:</td>
                                <td class="value">{{ gate_pass.material_description }}</td>
                            </tr>
                            <tr>
                                <td class="label">Type:</td>
                                <td class="value">{{ gate_pass.material_type|title }}</td>
                            </tr>
                            <tr>
                                <td class="label">Status:</td>
                                <td class="value">{{ gate_pass.material_status|title }}</td>
                            </tr>
                            <tr>
                                <td class="label">Destination:</td>
                                <td class="value">{{ gate_pass.destination }}</td>
                            </tr>
                            <tr>
                                <td class="label">Purpose:</td>
                                <td class="value">{{ gate_pass.purpose }}</td>
                            </tr>
                            {% if gate_pass.material_type == 'returnable' and gate_pass.expected_return_date %}
                            <tr>
                                <td class="label">Expected Return:</td>
                                <td class="value">{{ gate_pass.expected_return_date.strftime('%d/%m/%Y %H:%M') }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>

                <!-- Receiver & Creator Info -->
                <div class="row" style="display: flex; gap: 2mm; margin-bottom: 3mm;">
                    <div style="flex: 1;">
                        <div class="compact-card" style="height: 100%;">
                            <div class="compact-card-header">
                                RECEIVER INFORMATION
                            </div>
                            <div class="compact-card-body">
                                <table class="compact-table">
                                    <tr>
                                        <td class="label">Name:</td>
                                        <td class="value"><strong>{{ gate_pass.receiver_name }}</strong></td>
                                    </tr>
                                    {% if gate_pass.receiver_contact %}
                                    <tr>
                                        <td class="label">Contact:</td>
                                        <td class="value">{{ gate_pass.receiver_contact }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr>
                                        <td class="label">Send Date:</td>
                                        <td class="value">{{ gate_pass.send_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div style="flex: 1;">
                        <div class="compact-card" style="height: 100%;">
                            <div class="compact-card-header">
                                CREATED BY
                            </div>
                            <div class="compact-card-body">
                                <table class="compact-table">
                                    <tr>
                                        <td class="label">Name:</td>
                                        <td class="value">{{ gate_pass.creator_name }}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Designation:</td>
                                        <td class="value">{{ gate_pass.creator_designation }}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Department:</td>
                                        <td class="value">{{ gate_pass.department_name }}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Division:</td>
                                        <td class="value">{{ gate_pass.division_name }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material Photos -->
                {% if gate_pass.images_list %}
                <div class="compact-card">
                    <div class="compact-card-header">
                        MATERIAL PHOTOS ({{ gate_pass.images_list|length }})
                    </div>
                    <div class="compact-card-body">
                        <div class="compact-images">
                            {% for image in gate_pass.images_list[:4] %}
                            <div>
                                <img src="{{ url_for('static', filename=image) }}" 
                                     alt="Material Photo" class="compact-image">
                                <div style="font-size: 6pt; text-align: center; margin-top: 1px;">Photo {{ loop.index }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Important Notes -->
                <div class="important-notes page-break-avoid">
                    <strong>‚ö†Ô∏è SECURITY INSTRUCTIONS:</strong>
                    <ul style="margin: 1mm 0 0 0; padding-left: 4mm;">
                        <li>This is SECURITY COPY - Must remain at security office</li>
                        <li>Verify QR code when material goes out and returns</li>
                        <li>Check receiver identity before releasing material</li>
                        <li>For returnable items, ensure timely return</li>
                        <li>Report discrepancies to supervisor immediately</li>
                        <li>Give RECEIVER COPY to receiver with material</li>
                    </ul>
                </div>
            </div>

            <!-- Right Column: QR Code & Verification -->
            <div class="right-column">
                <!-- QR Code -->
                <div class="compact-card">
                    <div class="compact-card-header">
                        VERIFICATION QR CODE
                    </div>
                    <div class="compact-card-body">
                        <div class="compact-qr-container">
                            {% if gate_pass.qr_form_img %}
                            <img src="{{ gate_pass.qr_form_img }}" alt="QR Code" class="compact-qr-image">
                            {% else %}
                            <div style="width: 40mm; height: 40mm; background: #eee; display: flex; align-items: center; justify-content: center;">
                                QR Not Generated
                            </div>
                            {% endif %}
                            
                            {% if gate_pass.qr_code_form %}
                            <div class="compact-qr-text">
                                {{ gate_pass.qr_code_form[:30] }}...
                            </div>
                            {% endif %}
                        </div>
                        
                        <div style="font-size: 7pt; text-align: center; margin-top: 2mm;">
                            <strong>Scan at Gate Entry/Exit</strong><br>
                            Required for material verification
                        </div>
                    </div>
                </div>

                <!-- Approval Status -->
                <div class="compact-card">
                    <div class="compact-card-header">
                        APPROVAL STATUS
                    </div>
                    <div class="compact-card-body">
                        <div class="approval-grid">
                            <div class="approval-item">
                                <div style="font-weight: bold;">Department</div>
                                <div style="margin-top: 1mm;">
                                    {% if gate_pass.department_approval == 'approved' %}
                                    <span style="color: #2e7d32;">‚úì Approved</span>
                                    {% if gate_pass.department_approval_date %}
                                    <div style="font-size: 6pt;">{{ gate_pass.department_approval_date.strftime('%d/%m %H:%M') }}</div>
                                    {% endif %}
                                    {% elif gate_pass.department_approval == 'rejected' %}
                                    <span style="color: #c62828;">‚úó Rejected</span>
                                    {% else %}
                                    <span style="color: #f57c00;">‚è± Pending</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="approval-item">
                                <div style="font-weight: bold;">Store</div>
                                <div style="margin-top: 1mm;">
                                    {% if gate_pass.store_approval == 'approved' %}
                                    <span style="color: #2e7d32;">‚úì Approved</span>
                                    {% if gate_pass.store_approval_date %}
                                    <div style="font-size: 6pt;">{{ gate_pass.store_approval_date.strftime('%d/%m %H:%M') }}</div>
                                    {% endif %}
                                    {% elif gate_pass.store_approval == 'rejected' %}
                                    <span style="color: #c62828;">‚úó Rejected</span>
                                    {% else %}
                                    <span style="color: #f57c00;">‚è± Pending</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="approval-item">
                                <div style="font-weight: bold;">Security</div>
                                <div style="margin-top: 1mm;">
                                    {% if gate_pass.security_approval == 'approved' %}
                                    <span style="color: #2e7d32;">‚úì Approved</span>
                                    {% if gate_pass.security_approval_date %}
                                    <div style="font-size: 6pt;">{{ gate_pass.security_approval_date.strftime('%d/%m %H:%M') }}</div>
                                    {% endif %}
                                    {% if gate_pass.approved_by_security %}
                                    <div style="font-size: 6pt;">By: {{ gate_pass.approved_by_security|truncate(10) }}</div>
                                    {% endif %}
                                    {% elif gate_pass.security_approval == 'rejected' %}
                                    <span style="color: #c62828;">‚úó Rejected</span>
                                    {% else %}
                                    <span style="color: #f57c00;">‚è± Pending</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Information -->
                <div class="compact-card">
                    <div class="compact-card-header">
                        SECURITY INFORMATION
                    </div>
                    <div class="compact-card-body">
                        <table class="compact-table">
                            <tr>
                                <td class="label">Printed By:</td>
                                <td class="value">{{ security_name }}</td>
                            </tr>
                            <tr>
                                <td class="label">Print Date:</td>
                                <td class="value">{{ now.strftime('%d/%m/%Y %H:%M') }}</td>
                            </tr>
                            <tr>
                                <td class="label">Pass Number:</td>
                                <td class="value">{{ gate_pass.pass_number }}</td>
                            </tr>
                            <tr>
                                <td class="label">Document ID:</td>
                                <td class="value">GP-{{ gate_pass.pass_number }}-{{ now.strftime('%Y%m%d') }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signatures -->
        <div class="signature-section page-break-avoid">
            <div class="signature-row">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-text">
                        {% if gate_pass.dept_head_name %}
                        {{ gate_pass.dept_head_name }}
                        {% else %}
                        Department Head
                        {% endif %}
                    </div>
                    <div class="signature-designation">
                        Department Head Signature<br>
                        {% if gate_pass.department_approval_date %}
                        Date: {{ gate_pass.department_approval_date.strftime('%d/%m/%Y') }}
                        {% else %}
                        Date: __________________
                        {% endif %}
                    </div>
                </div>
                
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-text">{{ security_name }}</div>
                    <div class="signature-designation">
                        Security Officer Signature<br>
                        Date: {{ now.strftime('%d/%m/%Y') }}
                    </div>
                </div>
            </div>
            
            <div style="width: 60%; margin: 5mm auto 0 auto; text-align: center;">
                <div class="signature-line"></div>
                <div class="signature-text">{{ gate_pass.receiver_name }}</div>
                <div class="signature-designation">
                    Receiver Signature & Company Stamp<br>
                    Date: __________________
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="compact-footer">
            <div style="text-align: center; margin-bottom: 1mm;">
                <strong>NR GROUP GATE PASS SYSTEM v2.0</strong> | 
                Computer Generated Document | 
                Page 1 of 1
            </div>
            <div style="text-align: center;">
                Printed on: {{ now.strftime('%d/%m/%Y %H:%M:%S') }} | 
                Valid without signature | 
                For queries: Security Dept - Ext: 101
            </div>
            <div style="text-align: center; font-size: 6pt; margin-top: 1mm; color: #999;">
                ¬© 2024 NR Group. All rights reserved. Unauthorized duplication prohibited.
            </div>
        </div>
    </div>
</body>
</html>
{% endblock %}

{% block scripts %}
<script>
    // Initialize toast
    const printToast = new bootstrap.Toast(document.getElementById('printToast'));
    
    // Main print process function
    function startPrintProcess() {
        // Show confirmation for 2 copies
        if (confirm('üìã IMPORTANT: Print 2 copies:\n\n1. SECURITY OFFICE COPY (Keep for records)\n2. RECEIVER COPY (Give to receiver)\n\nClick OK to start printing...')) {
            // Show loading
            showLoading();
            
            // Step 1: Send notification
            sendPrintNotification();
        }
    }
    
    // Send notification to server
    function sendPrintNotification() {
        const gatePassId = "{{ gate_pass.id }}";
        const printedByName = "{{ security_name }}";
        
        fetch('/api/notify_gate_pass_printing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                gate_pass_id: gatePassId,
                printed_by: "{{ session['user_id'] }}",
                printed_by_name: printedByName,
                printed_by_role: "security",
                copies_printed: 2,
                note: "Security printed 2 copies: Security Office Copy + Receiver Copy"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Step 2: Adjust for print and trigger print
                adjustForPrintAndPrint();
            } else {
                showToast('Error sending notification: ' + data.message, 'error');
                hideLoading();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error sending notification', 'error');
            hideLoading();
        });
    }
    
    // Adjust layout for print and trigger print
    function adjustForPrintAndPrint() {
        // Hide web interface
        document.querySelectorAll('.no-print').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show print area
        document.querySelector('.print-container').style.display = 'block';
        
        // Adjust for single page
        adjustForSinglePage();
        
        // Trigger print
        setTimeout(() => {
            window.print();
        }, 500);
    }
    
    // Adjust layout to fit in single page
    function adjustForSinglePage() {
        const printContainer = document.querySelector('.print-container');
        const containerHeight = printContainer.scrollHeight;
        const maxHeight = 277; // A4 height in mm (297mm - 20mm margins)
        
        // If content is too long, reduce font sizes
        if (containerHeight > maxHeight * 3.78) { // Convert mm to pixels (3.78px per mm)
            // Reduce font sizes
            document.body.style.fontSize = '8pt';
            
            // Reduce QR code size
            const qrImage = document.querySelector('.compact-qr-image');
            if (qrImage) {
                qrImage.style.width = '35mm';
                qrImage.style.height = '35mm';
            }
            
            // Reduce image sizes
            document.querySelectorAll('.compact-image').forEach(img => {
                img.style.height = '12mm';
            });
            
            // Reduce padding
            document.querySelectorAll('.compact-card-body, .compact-card-header').forEach(el => {
                el.style.padding = '1mm 2mm';
            });
        }
        
        // Ensure all images are visible
        document.querySelectorAll('img').forEach(img => {
            img.style.visibility = 'visible';
            img.style.opacity = '1';
        });
    }
    
    // After print
    window.onafterprint = function() {
        // Send completion notification
        sendPrintCompleteNotification();
        
        // Hide loading
        hideLoading();
        
        // Show success message with instructions
        alert('‚úÖ Gate pass printed successfully!\n\nüìã IMPORTANT:\n‚Ä¢ Keep SECURITY OFFICE COPY for records\n‚Ä¢ Give RECEIVER COPY to receiver with material');
        
        // Redirect after delay
        setTimeout(() => {
            window.location.href = "{{ url_for('gate_pass.gate_pass_list') }}";
        }, 2000);
    };
    
    // Send completion notification
    function sendPrintCompleteNotification() {
        const gatePassId = "{{ gate_pass.id }}";
        
        fetch('/api/notify_gate_pass_print_complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                gate_pass_id: gatePassId,
                printed_by: "{{ session['user_id'] }}",
                pass_number: "{{ gate_pass.pass_number }}",
                copies_printed: 2
            })
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Show loading
    function showLoading() {
        // Create loading overlay
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingOverlay';
        loadingDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        
        loadingDiv.innerHTML = `
            <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
            <h4 class="mt-3">Preparing print...</h4>
            <p class="text-muted">Sending notifications and preparing 2 copies</p>
        `;
        
        document.body.appendChild(loadingDiv);
    }
    
    // Hide loading
    function hideLoading() {
        const loadingDiv = document.getElementById('loadingOverlay');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }
    
    // Show toast
    function showToast(message, type = 'success') {
        alert(message); // Simple alert for now
    }
</script>
{% endblock %}
[file content end]