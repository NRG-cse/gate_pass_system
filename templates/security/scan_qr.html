{% extends "base.html" %}

{% block page_title %}QR Code Scanner - Security{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>Scan QR Code for Material Return
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Camera Preview -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Camera Scanner</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div id="cameraPreview" class="border rounded mb-3" style="height: 300px; background: #f8f9fa;">
                                        <!-- Camera will be inserted here -->
                                    </div>
                                    <button id="startCamera" class="btn btn-primary">
                                        <i class="fas fa-camera me-2"></i>Start Camera
                                    </button>
                                    <button id="stopCamera" class="btn btn-secondary ms-2" disabled>
                                        <i class="fas fa-stop me-2"></i>Stop Camera
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Manual QR Input -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Manual QR Code Input</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Enter QR Code Data:</label>
                                        <textarea id="manualQrInput" class="form-control" rows="4" 
                                                  placeholder="Paste QR code data here or scan with camera..."></textarea>
                                    </div>
                                    <button id="processManualQr" class="btn btn-success w-100">
                                        <i class="fas fa-check me-2"></i>Process QR Code
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Scan Results -->
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">Scan Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="scanResult" class="text-center py-4">
                                        <div class="empty-state-icon mb-3">
                                            <i class="fas fa-qrcode fa-4x text-muted opacity-25"></i>
                                        </div>
                                        <h5 class="text-muted">No QR Code Scanned Yet</h5>
                                        <p class="text-muted small">
                                            Scan a QR code or manually enter QR data to mark material as returned
                                        </p>
                                    </div>
                                    
                                    <!-- Loading Indicator -->
                                    <div id="loadingIndicator" class="text-center d-none">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Processing QR code...</p>
                                    </div>
                                    
                                    <!-- Success Result -->
                                    <div id="successResult" class="d-none">
                                        <div class="alert alert-success">
                                            <h5><i class="fas fa-check-circle me-2"></i>Material Return Successful!</h5>
                                            <div id="successDetails" class="mt-3"></div>
                                        </div>
                                        <button id="scanAnother" class="btn btn-primary w-100">
                                            <i class="fas fa-redo me-2"></i>Scan Another QR Code
                                        </button>
                                    </div>
                                    
                                    <!-- Error Result -->
                                    <div id="errorResult" class="d-none">
                                        <div class="alert alert-danger">
                                            <h5><i class="fas fa-exclamation-circle me-2"></i>Scan Failed</h5>
                                            <p id="errorMessage" class="mb-0"></p>
                                        </div>
                                        <button id="tryAgain" class="btn btn-warning w-100">
                                            <i class="fas fa-redo me-2"></i>Try Again
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Scans -->
                            <div class="card mt-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Today's Returns</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div id="todayReturns" class="list-group list-group-flush">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<style>
#cameraPreview video {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 8px;
}
.empty-state-icon {
    opacity: 0.5;
}
.list-group-item {
    border: none;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}
</style>

<script>
let html5QrCode;
let cameraActive = false;

// Start Camera
document.getElementById('startCamera').addEventListener('click', function() {
    startCamera();
});

// Stop Camera
document.getElementById('stopCamera').addEventListener('click', function() {
    stopCamera();
});

// Manual QR Processing
document.getElementById('processManualQr').addEventListener('click', function() {
    const qrData = document.getElementById('manualQrInput').value.trim();
    if (qrData) {
        processQrCode(qrData);
    } else {
        showError('Please enter QR code data');
    }
});

// Scan Another
document.getElementById('scanAnother').addEventListener('click', function() {
    resetScanner();
});

// Try Again
document.getElementById('tryAgain').addEventListener('click', function() {
    resetScanner();
});

function startCamera() {
    const preview = document.getElementById('cameraPreview');
    
    html5QrCode = new Html5Qrcode("cameraPreview");
    
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        if (decodedText) {
            stopCamera();
            processQrCode(decodedText);
        }
    };
    
    const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 } 
    };
    
    html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeSuccessCallback,
        (errorMessage) => {
            console.log(`QR Code no longer in front of camera: ${errorMessage}`);
        }
    ).then(() => {
        cameraActive = true;
        document.getElementById('startCamera').disabled = true;
        document.getElementById('stopCamera').disabled = false;
    }).catch((err) => {
        console.error(`Unable to start camera: ${err}`);
        showError('Could not access camera. Please check permissions.');
    });
}

function stopCamera() {
    if (html5QrCode && cameraActive) {
        html5QrCode.stop().then(() => {
            cameraActive = false;
            document.getElementById('startCamera').disabled = false;
            document.getElementById('stopCamera').disabled = true;
            document.getElementById('cameraPreview').innerHTML = '';
        }).catch((err) => {
            console.error(`Unable to stop camera: ${err}`);
        });
    }
}

function processQrCode(qrData) {
    showLoading();
    
    fetch('/security/scan_qr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ qr_data: qrData })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            showSuccess(data);
            loadTodayReturns();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        hideLoading();
        showError('Network error. Please try again.');
        console.error('Error:', error);
    });
}

function showLoading() {
    document.getElementById('scanResult').classList.add('d-none');
    document.getElementById('loadingIndicator').classList.remove('d-none');
    document.getElementById('successResult').classList.add('d-none');
    document.getElementById('errorResult').classList.add('d-none');
}

function hideLoading() {
    document.getElementById('loadingIndicator').classList.add('d-none');
}

function showSuccess(data) {
    const successDetails = document.getElementById('successDetails');
    successDetails.innerHTML = `
        <div class="text-start">
            <p><strong>Pass Number:</strong> ${data.gate_pass.pass_number}</p>
            <p><strong>Material:</strong> ${data.gate_pass.material_description}</p>
            <p><strong>Department:</strong> ${data.gate_pass.department}</p>
            <p><strong>Return Time:</strong> ${data.gate_pass.return_time}</p>
            <p class="text-success"><strong>Status:</strong> âœ… Material Returned Successfully</p>
        </div>
    `;
    
    document.getElementById('scanResult').classList.add('d-none');
    document.getElementById('successResult').classList.remove('d-none');
    
    // Clear manual input
    document.getElementById('manualQrInput').value = '';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('scanResult').classList.add('d-none');
    document.getElementById('errorResult').classList.remove('d-none');
}

function resetScanner() {
    document.getElementById('scanResult').classList.remove('d-none');
    document.getElementById('successResult').classList.add('d-none');
    document.getElementById('errorResult').classList.add('d-none');
    document.getElementById('manualQrInput').value = '';
    
    // Restart camera if it was active
    if (cameraActive) {
        stopCamera();
        setTimeout(startCamera, 500);
    }
}

function loadTodayReturns() {
    fetch('/security/today_returns')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('todayReturns');
        if (data.success && data.returns.length > 0) {
            let html = '';
            data.returns.forEach(item => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${item.pass_number}</strong>
                                <br>
                                <small class="text-muted">${item.department}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">${item.return_time}</span>
                                <br>
                                <small class="text-muted">${item.material}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = `
                <div class="list-group-item text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                    <p class="text-muted mb-0">No returns today</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading returns:', error);
    });
}

// Load today's returns on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTodayReturns();
});

// Clean up camera on page unload
window.addEventListener('beforeunload', function() {
    stopCamera();
});
</script>
{% endblock %}