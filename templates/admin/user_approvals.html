{% extends "base.html" %}

{% block page_title %}User Approvals - System Admin{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-1">
                <i class="fas fa-user-check me-2"></i>User Approvals
            </h3>
            <p class="text-muted mb-0">
                <span class="badge bg-danger-gradient fs-6 px-3 py-2">
                    <i class="fas fa-user-shield me-1"></i>System Administrator
                </span>
                <span class="ms-2">You can approve users from ALL departments</span>
            </p>
        </div>
        <div>
            <a href="{{ url_for('admin.all_users') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-users me-2"></i>View All Users
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-danger border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-user-clock fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Pending Users</h6>
                            <h2 class="text-white mb-0">{{ total_pending }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-success border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-user-check fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Approved Users</h6>
                            <h2 class="text-white mb-0">{{ total_approved }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-primary border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-users fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Total Users</h6>
                            <h2 class="text-white mb-0">{{ total_users }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card bg-gradient-info border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-container">
                            <i class="fas fa-clock fa-2x text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-white-50 mb-1">Today</h6>
                            <h2 class="text-white mb-0">{{ now.strftime('%d %b') }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Users Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-dark">
                    <i class="fas fa-users text-danger me-2"></i>
                    Pending User Registration Requests
                </h5>
                {% if pending_users and pending_users|length > 0 %}
                <span class="badge bg-danger rounded-pill px-3 py-2">
                    {{ pending_users|length }} pending
                </span>
                {% endif %}
            </div>
        </div>
        <div class="card-body p-0">
            {% if pending_users and pending_users|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">User Details</th>
                            <th>Department & Division</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in pending_users %}
                        <tr id="admin-user-{{ user.id }}" class="user-row hover-lift">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-primary-gradient me-3">
                                        <span class="avatar-text">{{ user.name[0]|upper }}</span>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">{{ user.name }}</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-user me-1"></i>{{ user.username }}
                                        </small>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-briefcase me-1"></i>{{ user.designation }}
                                        </small>
                                        <br>
                                        <small class="text-success">
                                            <i class="fas fa-calendar me-1"></i>{{ user.created_at.strftime('%d %b, %H:%M') }}
                                        </small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="department-badge">
                                    <span class="badge bg-light text-dark border">
                                        <i class="fas fa-building me-1"></i>{{ user.department_name or 'No Department' }}
                                    </span>
                                    {% if user.division_name %}
                                    <br>
                                    <small class="text-muted mt-1 d-block">
                                        <i class="fas fa-sitemap me-1"></i>{{ user.division_name }}
                                    </small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info py-2 px-3">
                                    <i class="fas fa-user-tag me-1"></i>{{ user.role|replace('_', ' ')|title }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-warning-gradient py-2 px-3">
                                    <i class="fas fa-clock me-1"></i>{{ user.status|title }}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button onclick="adminApproveUser({{ user.id }}, 'approve')" 
                                            class="btn btn-success btn-sm rounded-start px-3 action-btn"
                                            title="Approve User"
                                            data-user="{{ user.id }}">
                                        <i class="fas fa-check me-1"></i>Approve
                                    </button>
                                    <button onclick="adminApproveUser({{ user.id }}, 'reject')" 
                                            class="btn btn-danger btn-sm rounded-end px-3 action-btn"
                                            title="Reject User"
                                            data-user="{{ user.id }}">
                                        <i class="fas fa-times me-1"></i>Reject
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="empty-state-icon mb-3">
                    <i class="fas fa-user-check fa-4x text-success opacity-25"></i>
                </div>
                <h5 class="fw-bold text-muted mb-2">No Pending Users</h5>
                <p class="text-muted mb-0">All user registrations have been processed</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Legend Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <h6 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i>System Admin Approval Guidelines:</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <i class="fas fa-check-circle text-success fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Approve Users</h6>
                                    <p class="text-muted mb-0 small">
                                        Only approve users after verifying their identity and department assignment.
                                        Security users must be in Security Division departments only.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <i class="fas fa-times-circle text-danger fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Reject Users</h6>
                                    <p class="text-muted mb-0 small">
                                        Reject users with incorrect information, duplicate accounts, 
                                        or unauthorized department assignments.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3">
    <!-- Success Toast -->
    <div id="successToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <div id="toastMessage">Operation completed successfully!</div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <div id="errorMessage">An error occurred!</div>
        </div>
    </div>
</div>

<style>
.stat-card {
    border-radius: 15px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
}

.bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
.bg-gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important; }
.bg-gradient-warning { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%) !important; }
.bg-gradient-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important; }
.bg-gradient-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%) !important; }

.stat-icon-container {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 18px;
}

.hover-lift {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.user-row {
    border-left: 4px solid transparent;
}

.user-row:hover {
    border-left-color: #ff416c;
    background-color: rgba(255, 65, 108, 0.05);
}

.action-btn {
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Admin approve user function
function adminApproveUser(userId, action) {
    const actionText = action === 'approve' ? 'Approve' : 'Reject';
    const icon = action === 'approve' ? '✅' : '❌';
    
    if (!confirm(`${icon} Are you sure you want to ${actionText} this user as System Admin?`)) {
        return;
    }
    
    const button = document.querySelector(`button[data-user="${userId}"]`);
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    fetch(`/approve_user/${userId}/${action}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message || `User ${actionText.toLowerCase()}d successfully!`, 'success');
                // Remove the user row from table
                const userRow = document.getElementById(`admin-user-${userId}`);
                if (userRow) {
                    userRow.style.transition = 'all 0.3s ease';
                    userRow.style.transform = 'translateX(100%)';
                    userRow.style.opacity = '0';
                    
                    setTimeout(() => {
                        userRow.remove();
                        updateAdminStatsCount();
                        
                        // Check if table is empty
                        const tableBody = document.querySelector('table tbody');
                        if (tableBody && tableBody.children.length === 0) {
                            showEmptyState();
                        }
                    }, 300);
                }
            } else {
                showToast(data.message || `Error ${actionText.toLowerCase()}ing user`, 'error');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

// Update stats count
function updateAdminStatsCount() {
    const userRows = document.querySelectorAll('.user-row');
    const pendingBadge = document.querySelector('.badge.bg-danger');
    
    if (pendingBadge) {
        pendingBadge.textContent = `${userRows.length} pending`;
    }
    
    // Update stat card
    const statCard = document.querySelector('.stat-card.bg-gradient-danger h2');
    if (statCard) {
        statCard.textContent = userRows.length;
    }
}

// Show empty state
function showEmptyState() {
    const cardBody = document.querySelector('.card-body');
    if (cardBody && !cardBody.querySelector('.empty-state-icon')) {
        cardBody.innerHTML = `
            <div class="text-center py-5">
                <div class="empty-state-icon mb-3">
                    <i class="fas fa-user-check fa-4x text-success opacity-25"></i>
                </div>
                <h5 class="fw-bold text-muted mb-2">No Pending Users</h5>
                <p class="text-muted mb-0">All user registrations have been processed</p>
            </div>
        `;
    }
}

// Toast notification
function showToast(message, type = 'success') {
    let toastElement, toastMessage;
    
    if (type === 'error') {
        toastElement = document.getElementById('errorToast');
        toastMessage = document.getElementById('errorMessage');
    } else {
        toastElement = document.getElementById('successToast');
        toastMessage = document.getElementById('toastMessage');
    }
    
    if (!toastElement || !toastMessage) return;
    
    toastMessage.textContent = message;
    const timeElement = toastElement.querySelector('small');
    if (timeElement) {
        const now = new Date();
        timeElement.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    const bsToast = new bootstrap.Toast(toastElement);
    bsToast.show();
}

// Add animation to table rows
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.user-row');
    rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            row.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Auto-hide toasts after 5 seconds
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(toast => {
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    });
});
</script>
{% endblock %}