{% extends "base.html" %}

{% block page_title %}Returned Gate Passes{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-undo me-2"></i>Returned Gate Passes
                    </h5>
                    <div>
                        <button class="btn btn-light btn-sm" onclick="loadReturns()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        {% if session.role == 'security' %}
                        <a href="/security/scan" class="btn btn-light btn-sm ms-2">
                            <i class="fas fa-qrcode"></i> Scan QR
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filter Section -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label class="form-label">Date From</label>
                            <input type="date" id="dateFrom" class="form-control" 
                                   value="{{ now.strftime('%Y-%m-%d') if now else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date To</label>
                            <input type="date" id="dateTo" class="form-control" 
                                   value="{{ now.strftime('%Y-%m-%d') if now else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Department</label>
                            <select id="departmentFilter" class="form-select">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="loadReturns()">
                                <i class="fas fa-filter me-2"></i>Filter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Total Returns</h6>
                                    <h3 id="totalReturns" class="mb-0">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Today</h6>
                                    <h3 id="todayReturns" class="mb-0">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">This Week</h6>
                                    <h3 id="weekReturns" class="mb-0">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">This Month</h6>
                                    <h3 id="monthReturns" class="mb-0">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Returns Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="returnsTable">
                            <thead>
                                <tr>
                                    <th>Pass No.</th>
                                    <th>Return Date</th>
                                    <th>Material</th>
                                    <th>Department</th>
                                    <th>Returned By</th>
                                    <th>Return Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="returnsBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loadingReturns" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading returns...</p>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyReturns" class="text-center py-4 d-none">
                        <div class="empty-state-icon mb-3">
                            <i class="fas fa-inbox fa-4x text-muted"></i>
                        </div>
                        <h5 class="text-muted">No Returns Found</h5>
                        <p class="text-muted">Try adjusting your filters</p>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
const itemsPerPage = 10;

document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    if (!document.getElementById('dateFrom').value) {
        document.getElementById('dateFrom').value = today;
    }
    if (!document.getElementById('dateTo').value) {
        document.getElementById('dateTo').value = today;
    }
    
    loadReturns();
    loadStatistics();
});

function loadReturns() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const departmentId = document.getElementById('departmentFilter').value;
    
    showLoading();
    
    fetch(`/api/returns_list?page=${currentPage}&per_page=${itemsPerPage}&date_from=${dateFrom}&date_to=${dateTo}&department_id=${departmentId}`)
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            populateReturns(data.returns);
            setupPagination(data.total, data.per_page, data.current_page);
        } else {
            showEmptyState(data.message || 'Error loading returns');
        }
    })
    .catch(error => {
        hideLoading();
        showEmptyState('Error loading returns');
        console.error('Error:', error);
    });
}

function loadStatistics() {
    fetch('/api/returns_statistics')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('totalReturns').textContent = data.statistics.total_returns || 0;
            document.getElementById('todayReturns').textContent = data.statistics.today_returns || 0;
            document.getElementById('weekReturns').textContent = data.statistics.week_returns || 0;
            document.getElementById('monthReturns').textContent = data.statistics.month_returns || 0;
        } else {
            console.error('Error loading statistics:', data.message);
        }
    })
    .catch(error => {
        console.error('Error loading statistics:', error);
    });
}

function populateReturns(returns) {
    const tbody = document.getElementById('returnsBody');
    
    if (!returns || returns.length === 0) {
        showEmptyState('No returns found');
        return;
    }
    
    let html = '';
    returns.forEach(item => {
        const returnType = item.security_approval_date ? 
            (item.returned_by_security ? 'Manual' : 'QR Scan') : 'Unknown';
        const returnBadge = returnType === 'QR Scan' ? 
            '<span class="badge bg-info"><i class="fas fa-qrcode"></i> QR Scan</span>' : 
            '<span class="badge bg-warning"><i class="fas fa-keyboard"></i> Manual</span>';
        
        html += `
            <tr>
                <td>
                    <strong>${item.pass_number || 'N/A'}</strong><br>
                    <small class="text-muted">Created: ${item.created_date || 'N/A'}</small>
                </td>
                <td>
                    <span class="badge bg-success">${item.return_date || 'N/A'}</span><br>
                    <small class="text-muted">${item.return_time || 'N/A'}</small>
                </td>
                <td>
                    <div style="max-width: 250px;">
                        <strong>${item.material_description || 'N/A'}</strong><br>
                        <small class="text-muted">${item.purpose || 'N/A'}</small>
                    </div>
                </td>
                <td>
                    ${item.department_name || 'N/A'}<br>
                    <small class="text-muted">${item.division_name || 'N/A'}</small>
                </td>
                <td>
                    ${item.returned_by_security || 'N/A'}<br>
                    <small class="text-muted">Security</small>
                </td>
                <td>
                    ${returnBadge}
                </td>
                <td>
                    <a href="/gate_pass/gate_pass_detail/${item.id || item.gate_pass_id}" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    document.getElementById('emptyReturns').classList.add('d-none');
}

function showLoading() {
    document.getElementById('loadingReturns').classList.remove('d-none');
    document.getElementById('returnsBody').innerHTML = '';
    document.getElementById('emptyReturns').classList.add('d-none');
}

function hideLoading() {
    document.getElementById('loadingReturns').classList.add('d-none');
}

function showEmptyState(message) {
    document.getElementById('returnsBody').innerHTML = '';
    document.getElementById('emptyReturns').classList.remove('d-none');
    document.getElementById('emptyReturns').querySelector('h5').textContent = message;
}

function setupPagination(totalItems, perPage, currentPage) {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(totalItems / perPage);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
        </a>
    </li>`;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
        }
    }
    
    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
        </a>
    </li>`;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    loadReturns();
}
</script>
{% endblock %}