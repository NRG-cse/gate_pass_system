{% extends "base.html" %}

{% block page_title %}
    {% if user_role == 'store_manager' %}
        Store Manager - Gate Pass Approvals
    {% elif session.role == 'security' %}
        Security - View Gate Passes
    {% elif session.role == 'department_head' %}
        Department Head - Gate Pass Management
    {% elif session.role == 'system_admin' %}
        All Gate Passes (System)
    {% else %}
        My Gate Passes
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="fw-bold text-primary">
                        {% if user_role == 'store_manager' %}
                            <i class="fas fa-passport me-2"></i>Store Manager - Gate Pass Approvals
                        {% elif session.role == 'department_head' %}
                            <i class="fas fa-passport me-2"></i>My Department Gate Passes
                        {% elif session.role == 'security' %}
                            <i class="fas fa-passport me-2"></i>Security - View Gate Passes
                        {% elif session.role == 'system_admin' %}
                            <i class="fas fa-passport me-2"></i>All Gate Passes (System)
                        {% else %}
                            <i class="fas fa-passport me-2"></i>My Gate Passes
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0">
                        {% if user_role == 'store_manager' %}
                            <i class="fas fa-info-circle me-2"></i>
                            Approve/reject gate passes from all departments
                        {% elif session.role == 'security' %}
                            <i class="fas fa-info-circle me-2"></i>
                            View all approved gate passes from all departments (No approval required)
                        {% elif session.role == 'department_head' %}
                            <i class="fas fa-info-circle me-2"></i>
                            View and manage gate passes from your department
                        {% elif session.role == 'system_admin' %}
                            <i class="fas fa-info-circle me-2"></i>
                            View and manage all gate passes in the system
                        {% else %}
                            <i class="fas fa-info-circle me-2"></i>
                            View your gate passes
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if session.role != 'security' and session.role != 'store_manager' %}
                    <a href="{{ url_for('gate_pass.create_gate_pass') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Create Gate Pass
                    </a>
                    {% endif %}
                    
                    {% if user_role == 'store_manager' %}
                    <a href="{{ url_for('gate_pass.create_store_request') }}" class="btn btn-success btn-lg ms-2">
                        <i class="fas fa-shopping-cart me-2"></i>New Store Request
                    </a>
                    <a href="{{ url_for('gate_pass.store_material_log') }}" class="btn btn-info btn-lg ms-2">
                        <i class="fas fa-exchange-alt me-2"></i>Material Log
                    </a>
                    {% endif %}
                    
                    {% if session.role == 'security' %}
                    <a href="{{ url_for('security_scan_page') }}" class="btn btn-success btn-lg ms-2">
                        <i class="fas fa-qrcode me-2"></i>Scan QR Code
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- For Store Managers: Store Requests Section -->
    {% if user_role == 'store_manager' and store_requests %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>My Store Requests
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Request Details</th>
                                    <th>Status</th>
                                    <th>Urgency</th>
                                    <th>Admin Response</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in store_requests %}
                                <tr>
                                    <td class="ps-4">
                                        <h6 class="fw-bold mb-1">{{ request.material_description[:80] }}{% if request.material_description|length > 80 %}...{% endif %}</h6>
                                        <small class="text-muted">To: {{ request.destination }}</small>
                                        <br>
                                        <small class="text-muted">Purpose: {{ request.purpose[:60] }}</small>
                                    </td>
                                    <td>
                                        {% if request.status == 'pending' %}
                                        <span class="badge bg-warning py-2 px-3">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                        {% elif request.status == 'approved' %}
                                        <span class="badge bg-success py-2 px-3">
                                            <i class="fas fa-check me-1"></i>Approved
                                        </span>
                                        {% elif request.status == 'rejected' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-times me-1"></i>Rejected
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info py-2 px-3">
                                            <i class="fas fa-cog me-1"></i>Processing
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if request.urgency == 'urgent' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Urgent
                                        </span>
                                        {% elif request.urgency == 'emergency' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-skull-crossbones me-1"></i>Emergency
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary py-2 px-3">
                                            <i class="fas fa-check me-1"></i>Normal
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if request.admin_response %}
                                        <small class="text-muted">{{ request.admin_response[:80] }}</small>
                                        {% if request.admin_response|length > 80 %}...{% endif %}
                                        {% else %}
                                        <small class="text-muted">Waiting for response...</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ request.created_at.strftime('%d/%m/%Y') }}</small>
                                        <br>
                                        <small class="text-muted">{{ request.created_at.strftime('%I:%M %p') }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gate Passes Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-primary">
                    <i class="fas fa-list me-2"></i>
                    {% if user_role == 'store_manager' %}
                        Gate Passes for Approval
                    {% elif session.role == 'security' %}
                        Approved Gate Passes (View Only)
                    {% elif session.role == 'department_head' %}
                        Department Gate Passes
                    {% else %}
                        Gate Passes
                    {% endif %}
                    {% if user_role == 'store_manager' or session.role == 'security' %}
                        (All Departments)
                    {% endif %}
                </h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshTable()" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <span class="badge bg-primary rounded-pill px-3 py-2">
                        {{ gate_passes|length }} passes
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if gate_passes %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Gate Pass Details</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Approved By</th>
                            <th>Created</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pass in gate_passes %}
                        <tr id="gatepass-{{ pass.id }}">
                            <td class="ps-4">
                                <div>
                                    <h6 class="fw-bold mb-1 text-primary">
                                        <i class="fas fa-passport me-2"></i>{{ pass.pass_number }}
                                    </h6>
                                    <p class="mb-1 text-muted small">
                                        <i class="fas fa-box me-1"></i>
                                        {{ pass.material_description[:60] }}{% if pass.material_description|length > 60 %}...{% endif %}
                                    </p>
                                    <p class="mb-0 text-muted small">
                                        <i class="fas fa-user me-1"></i>By {{ pass.creator_name }}
                                    </p>
                                </div>
                            </td>
                            <td>
                                <div class="department-badge">
                                    <span class="badge bg-light text-dark border">
                                        <i class="fas fa-building me-1"></i>{{ pass.department_name }}
                                    </span>
                                    {% if pass.division_name %}
                                    <br>
                                    <small class="text-muted mt-1 d-block">
                                        <i class="fas fa-sitemap me-1"></i>{{ pass.division_name }}
                                    </small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if pass.status == 'approved' %}
                                <span class="badge bg-success py-2 px-3">
                                    <i class="fas fa-check-circle me-1"></i>Approved
                                </span>
                                {% if pass.department_approval_date %}
                                <br>
                                <small class="text-success mt-1 d-block">
                                    <i class="fas fa-calendar-check me-1"></i>{{ pass.department_approval_date.strftime('%d/%m %H:%M') }}
                                </small>
                                {% endif %}
                                {% elif pass.status == 'pending_dept' %}
                                <span class="badge bg-warning py-2 px-3">
                                    <i class="fas fa-clock me-1"></i>Pending Dept
                                </span>
                                {% elif pass.status == 'pending_store' %}
                                <span class="badge bg-info py-2 px-3">
                                    <i class="fas fa-store me-1"></i>Pending Store
                                </span>
                                {% elif pass.status == 'pending_security' %}
                                <span class="badge bg-primary py-2 px-3">
                                    <i class="fas fa-shield-alt me-1"></i>Pending Security
                                </span>
                                {% elif pass.status == 'rejected' %}
                                <span class="badge bg-danger py-2 px-3">
                                    <i class="fas fa-times me-1"></i>Rejected
                                </span>
                                {% elif pass.status == 'inquiry' %}
                                <span class="badge bg-info py-2 px-3">
                                    <i class="fas fa-question-circle me-1"></i>Inquiry
                                </span>
                                {% elif pass.status == 'in_transit' %}
                                <span class="badge bg-warning py-2 px-3">
                                    <i class="fas fa-truck me-1"></i>In Transit
                                </span>
                                {% else %}
                                <span class="badge bg-secondary py-2 px-3">
                                    <i class="fas fa-clock me-1"></i>{{ pass.status|replace('_', ' ')|title }}
                                </span>
                                {% endif %}
                                
                                <!-- Urgent status -->
                                {% if pass.urgent %}
                                <br>
                                <span class="badge bg-danger mt-1">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Urgent
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pass.department_approval == 'approved' %}
                                <small class="text-muted">Department Head</small>
                                <br>
                                <small class="text-muted">{{ pass.department_approval_date.strftime('%d/%m %H:%M') if pass.department_approval_date else '' }}</small>
                                {% elif pass.store_approval == 'approved' %}
                                <small class="text-muted">Store Manager</small>
                                <br>
                                <small class="text-muted">{{ pass.store_approval_date.strftime('%d/%m %H:%M') if pass.store_approval_date else '' }}</small>
                                {% else %}
                                <small class="text-muted">Not approved yet</small>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ pass.created_at.strftime('%d/%m/%Y') }}</small>
                                <br>
                                <small class="text-muted">{{ pass.created_at.strftime('%I:%M %p') }}</small>
                            </td>
                            <td class="text-center">
                                <!-- Action Buttons Section - FIXED VERSION -->
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- View Button (Always visible) -->
                                    <a href="{{ url_for('gate_pass.gate_pass_detail', gate_pass_id=pass.id) }}" 
                                       class="btn btn-outline-primary px-3"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    <!-- ‚úÖ FIXED: Department Head Actions -->
                                    {% if session.role == 'department_head' and pass.department_id == current_user_department_id %}
                                        <!-- Edit Button (only for draft/pending_dept) -->
                                        {% if pass.status in ['draft', 'pending_dept'] %}
                                        <button type="button" class="btn btn-outline-warning px-3" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editGatePassModal"
                                                onclick="loadGatePassForEdit({{ pass.id }})"
                                                title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <!-- Delete Button (only for draft/pending_dept) -->
                                        {% if pass.status in ['draft', 'pending_dept'] %}
                                        <button onclick="deleteGatePassByDeptHead({{ pass.id }})" 
                                                class="btn btn-outline-danger px-3"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <!-- ‚úÖ FIXED: DIRECT Approve/Reject/Inquiry Buttons (only for pending_dept) -->
                                        {% if pass.status == 'pending_dept' %}
                                        <button onclick="directApproveGatePass({{ pass.id }}, 'approve', 'department_head')" 
                                                class="btn btn-outline-success px-3"
                                                title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button onclick="directRejectGatePass({{ pass.id }}, 'reject', 'department_head')" 
                                                class="btn btn-outline-danger px-3"
                                                title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <button onclick="directInquiryGatePass({{ pass.id }})" 
                                                class="btn btn-outline-info px-3"
                                                title="Mark for Inquiry">
                                            <i class="fas fa-question-circle"></i>
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- ‚úÖ FIXED: Store Manager Actions -->
                                    {% if session.role == 'store_manager' %}
                                        {% if pass.status == 'pending_store' %}
                                        <button onclick="directApproveGatePass({{ pass.id }}, 'approve', 'store_manager')" 
                                                class="btn btn-outline-success px-3"
                                                title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button onclick="directRejectGatePass({{ pass.id }}, 'reject', 'store_manager')" 
                                                class="btn btn-outline-danger px-3"
                                                title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                        
                                        {% if pass.status == 'approved' %}
                                        <button onclick="markDispatched({{ pass.id }})" 
                                                class="btn btn-outline-success px-3"
                                                title="Mark as Dispatched">
                                            <i class="fas fa-truck"></i>
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- ‚úÖ FIXED: Security Actions -->
                                    {% if session.role == 'security' %}
                                        {% if pass.status == 'pending_security' %}
                                        <button onclick="securityApproveGatePass({{ pass.id }}, 'approve')" 
                                                class="btn btn-outline-success px-3"
                                                title="Approve">
                                            <i class="fas fa-shield-alt"></i>
                                        </button>
                                        <button onclick="securityApproveGatePass({{ pass.id }}, 'reject')" 
                                                class="btn btn-outline-danger px-3"
                                                title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                        
                                        {% if pass.status == 'approved' %}
                                        <a href="{{ url_for('security_print_gate_pass', gate_pass_id=pass.id) }}" 
                                           class="btn btn-outline-info px-3"
                                           title="Print Security Copy"
                                           target="_blank">
                                            <i class="fas fa-print"></i>
                                        </a>
                                        {% endif %}
                                        
                                        {% if pass.status == 'approved' and pass.material_type == 'returnable' and not pass.actual_return_date %}
                                        <button onclick="markReturned({{ pass.id }})" 
                                                class="btn btn-warning px-3"
                                                title="Mark as Returned">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="empty-state-icon mb-3">
                    <i class="fas fa-passport fa-4x text-primary opacity-25"></i>
                </div>
                <h5 class="fw-bold text-muted mb-2">No Gate Passes Found</h5>
                <p class="text-muted mb-0">
                    {% if session.role != 'security' and session.role != 'store_manager' and session.role != 'system_admin' and session.role != 'department_head' %}
                    Create your first gate pass to get started
                    {% elif session.role == 'security' %}
                    No approved gate passes available at the moment
                    {% elif user_role == 'store_manager' %}
                    No gate passes pending store approval
                    {% elif session.role == 'department_head' %}
                    No gate passes from your department
                    {% elif session.role == 'system_admin' %}
                    No gate passes in the system
                    {% else %}
                    No gate passes available at the moment
                    {% endif %}
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ‚úÖ FIXED: DIRECT APPROVE MODAL (SIMPLE) -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveModalLabel">
                    <i class="fas fa-check me-2"></i>Approve Gate Pass
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="approveComment" class="form-label">
                        <i class="fas fa-sticky-note me-1"></i>Comment (Optional)
                    </label>
                    <textarea class="form-control" id="approveComment" rows="3" 
                              placeholder="Add optional comment..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitDirectApprove()">
                    <i class="fas fa-check me-1"></i>Approve
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ FIXED: DIRECT REJECT MODAL (SIMPLE) -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="fas fa-times me-2"></i>Reject Gate Pass
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectComment" class="form-label">
                        <i class="fas fa-sticky-note me-1"></i>Reason (Optional)
                    </label>
                    <textarea class="form-control" id="rejectComment" rows="3" 
                              placeholder="Add optional reason..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitDirectReject()">
                    <i class="fas fa-times me-1"></i>Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ FIXED: DIRECT INQUIRY MODAL (SIMPLE) -->
<div class="modal fade" id="inquiryModal" tabindex="-1" aria-labelledby="inquiryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inquiryModalLabel">
                    <i class="fas fa-question-circle me-2"></i>Mark for Inquiry
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="inquiryComment" class="form-label">
                        <i class="fas fa-sticky-note me-1"></i>Inquiry Purpose (Required)
                    </label>
                    <textarea class="form-control" id="inquiryComment" rows="3" 
                              placeholder="Explain the purpose of inquiry..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitDirectInquiry()">
                    <i class="fas fa-paper-plane me-1"></i>Submit Inquiry
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <div id="toastMessage">Operation completed successfully!</div>
        </div>
    </div>
    
    <div id="errorToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <div id="errorMessage">An error occurred!</div>
        </div>
    </div>
</div>

<!-- Edit Gate Pass Modal -->
<div class="modal fade" id="editGatePassModal" tabindex="-1" aria-labelledby="editGatePassModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGatePassModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Gate Pass
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGatePassForm">
                    <input type="hidden" id="editGatePassId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editMaterialDescription" class="form-label">Material Description</label>
                            <textarea class="form-control" id="editMaterialDescription" rows="2" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editDestination" class="form-label">Destination</label>
                            <input type="text" class="form-control" id="editDestination" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editPurpose" class="form-label">Purpose</label>
                            <textarea class="form-control" id="editPurpose" rows="2" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editReceiverName" class="form-label">Receiver Name</label>
                            <input type="text" class="form-control" id="editReceiverName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editReceiverContact" class="form-label">Receiver Contact</label>
                            <input type="text" class="form-control" id="editReceiverContact">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditGatePass()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom Styles */
.card {
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.08);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px 12px 0 0 !important;
}

.table th {
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table th:nth-child(3) {
    min-width: 150px;
}

.table td {
    vertical-align: middle;
    padding: 1rem;
}

.badge {
    font-weight: 500;
    letter-spacing: 0.3px;
}

.empty-state-icon {
    opacity: 0.5;
}

.department-badge .badge {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.toast {
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.btn-group .btn {
    border-radius: 8px !important;
    margin: 2px;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 8px !important;
        margin: 2px 0;
    }
}
</style>

<script>
// ‚úÖ FIXED: GLOBAL VARIABLES FOR DIRECT APPROVAL
let currentDirectApproval = {
    passId: null,
    action: null,
    role: null
};

// ‚úÖ FIXED: DIRECT APPROVE FUNCTION (DEPARTMENT HEAD & STORE MANAGER)
function directApproveGatePass(passId, action, role) {
    currentDirectApproval = {
        passId: passId,
        action: action,
        role: role
    };
    
    // Clear previous comment
    document.getElementById('approveComment').value = '';
    
    // Show simple modal
    const modal = new bootstrap.Modal(document.getElementById('approveModal'));
    modal.show();
}

// ‚úÖ FIXED: DIRECT REJECT FUNCTION (DEPARTMENT HEAD & STORE MANAGER)
function directRejectGatePass(passId, action, role) {
    currentDirectApproval = {
        passId: passId,
        action: action,
        role: role
    };
    
    // Clear previous comment
    document.getElementById('rejectComment').value = '';
    
    // Show simple modal
    const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
    modal.show();
}

// ‚úÖ FIXED: DIRECT INQUIRY FUNCTION (DEPARTMENT HEAD ONLY)
function directInquiryGatePass(passId) {
    currentDirectApproval = {
        passId: passId,
        action: 'inquiry',
        role: 'department_head'
    };
    
    // Clear previous comment
    document.getElementById('inquiryComment').value = '';
    
    // Show simple modal
    const modal = new bootstrap.Modal(document.getElementById('inquiryModal'));
    modal.show();
}

// ‚úÖ FIXED: SUBMIT DIRECT APPROVE (INSTANT)
function submitDirectApprove() {
    const { passId, action, role } = currentDirectApproval;
    const comment = document.getElementById('approveComment')?.value.trim() || '';
    
    if (!passId || !role) {
        showToast('Error: Approval data missing!', 'error');
        return;
    }
    
    // Close modal IMMEDIATELY
    const modal = bootstrap.Modal.getInstance(document.getElementById('approveModal'));
    if (modal) modal.hide();
    
    // Disable button and show loading
    const button = document.querySelector(`button[onclick*="${passId}"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    // Show immediate feedback
    showToast('Processing approval...', 'info');
    
    // Send request IMMEDIATELY
    fetch(`/gate_pass/approve_gate_pass_with_comment/${passId}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ comment: comment })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`‚úÖ ${data.message}`, 'success');
            
            // Remove row immediately with animation
            const row = document.getElementById(`gatepass-${passId}`);
            if (row) {
                row.style.transition = 'all 0.3s ease';
                row.style.transform = 'translateX(100%)';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            
            // Auto-refresh page after 1 second
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(`‚ùå ${data.message}`, 'error');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error. Please try again.', 'error');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i>';
        }
    });
}

// ‚úÖ FIXED: SUBMIT DIRECT REJECT (INSTANT)
function submitDirectReject() {
    const { passId, action, role } = currentDirectApproval;
    const comment = document.getElementById('rejectComment')?.value.trim() || '';
    
    if (!passId || !role) {
        showToast('Error: Approval data missing!', 'error');
        return;
    }
    
    // Close modal IMMEDIATELY
    const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
    if (modal) modal.hide();
    
    // Disable button and show loading
    const button = document.querySelector(`button[onclick*="${passId}"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    // Show immediate feedback
    showToast('Processing rejection...', 'info');
    
    // Send request IMMEDIATELY
    fetch(`/gate_pass/approve_gate_pass_with_comment/${passId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ comment: comment })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`‚úÖ ${data.message}`, 'success');
            
            // Remove row immediately with animation
            const row = document.getElementById(`gatepass-${passId}`);
            if (row) {
                row.style.transition = 'all 0.3s ease';
                row.style.transform = 'translateX(100%)';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            
            // Auto-refresh page after 1 second
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(`‚ùå ${data.message}`, 'error');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-times"></i>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error. Please try again.', 'error');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-times"></i>';
        }
    });
}

// ‚úÖ FIXED: SUBMIT DIRECT INQUIRY (INSTANT)
function submitDirectInquiry() {
    const { passId } = currentDirectApproval;
    const inquiryPurpose = document.getElementById('inquiryComment')?.value.trim() || '';
    
    if (!passId) {
        showToast('Error: Gate pass ID missing!', 'error');
        return;
    }
    
    if (!inquiryPurpose) {
        showToast('Please enter inquiry purpose!', 'error');
        return;
    }
    
    // Close modal IMMEDIATELY
    const modal = bootstrap.Modal.getInstance(document.getElementById('inquiryModal'));
    if (modal) modal.hide();
    
    // Disable button and show loading
    const button = document.querySelector(`button[onclick*="${passId}"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    // Show immediate feedback
    showToast('Processing inquiry...', 'info');
    
    // Send request IMMEDIATELY
    fetch(`/gate_pass/approve_gate_pass/${passId}/inquiry?inquiry_purpose=${encodeURIComponent(inquiryPurpose)}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`‚úÖ ${data.message}`, 'success');
            
            // Remove row immediately with animation
            const row = document.getElementById(`gatepass-${passId}`);
            if (row) {
                row.style.transition = 'all 0.3s ease';
                row.style.transform = 'translateX(100%)';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            
            // Auto-refresh page after 1 second
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(`‚ùå ${data.message}`, 'error');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-question-circle"></i>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error. Please try again.', 'error');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-question-circle"></i>';
        }
    });
}

// ‚úÖ Department Head: Edit Gate Pass
function loadGatePassForEdit(passId) {
    fetch(`/gate_pass/get_gate_pass_details/${passId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const gatePass = data.gate_pass;
                document.getElementById('editGatePassId').value = passId;
                document.getElementById('editMaterialDescription').value = gatePass.material_description;
                document.getElementById('editDestination').value = gatePass.destination;
                document.getElementById('editPurpose').value = gatePass.purpose;
                document.getElementById('editReceiverName').value = gatePass.receiver_name;
                document.getElementById('editReceiverContact').value = gatePass.receiver_contact || '';
            } else {
                showToast('Error loading gate pass details', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error loading data', 'error');
        });
}

function submitEditGatePass() {
    const gatePassId = document.getElementById('editGatePassId').value;
    const formData = new FormData();
    
    formData.append('material_description', document.getElementById('editMaterialDescription').value);
    formData.append('destination', document.getElementById('editDestination').value);
    formData.append('purpose', document.getElementById('editPurpose').value);
    formData.append('receiver_name', document.getElementById('editReceiverName').value);
    formData.append('receiver_contact', document.getElementById('editReceiverContact').value);
    
    showToast('Updating gate pass...', 'info');
    
    fetch(`/gate_pass/department/edit_gate_pass/${gatePassId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Gate pass updated successfully!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editGatePassModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Error updating gate pass', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating gate pass', 'error');
    });
}

// ‚úÖ Department Head: Delete Gate Pass
function deleteGatePassByDeptHead(passId) {
    if (!confirm('üóëÔ∏è Are you sure you want to delete this gate pass?')) return;
    
    showToast('Deleting gate pass...', 'info');
    
    fetch(`/gate_pass/department/delete_gate_pass/${passId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Gate pass deleted successfully!', 'success');
            
            // Remove row immediately
            const row = document.getElementById(`gatepass-${passId}`);
            if (row) row.remove();
            
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Error deleting gate pass', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting gate pass', 'error');
    });
}

// ‚úÖ Store Manager: Mark as Dispatched
function markDispatched(gatePassId) {
    if (!confirm('üöö Mark this material as dispatched from store?')) return;
    
    showToast('Marking as dispatched...', 'info');
    
    fetch(`/gate_pass/store/mark_dispatched/${gatePassId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Material marked as dispatched!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Error marking as dispatched', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
    });
}

// ‚úÖ Security: Mark as Returned
function markReturned(passId) {
    if (!confirm('üì¶ Mark this returnable material as returned?')) return;
    
    showToast('Marking as returned...', 'info');
    
    fetch(`/mark_returned/${passId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Material marked as returned!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Error marking as returned', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
    });
}

// ‚úÖ Security: Approve/Reject Gate Pass
function securityApproveGatePass(passId, action) {
    const actionText = action === 'approve' ? 'Approve' : 'Reject';
    const icon = action === 'approve' ? '‚úÖ' : '‚ùå';
    
    if (!confirm(`${icon} ${actionText} this gate pass as Security Officer?`)) return;
    
    showToast('Processing security approval...', 'info');
    
    // Disable button immediately
    const button = document.querySelector(`button[onclick*="${passId}"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    fetch(`/security/approve_gate_pass/${passId}/${action}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Gate pass approved successfully!', 'success');
            
            // Remove row immediately
            const row = document.getElementById(`gatepass-${passId}`);
            if (row) {
                row.style.transition = 'all 0.3s ease';
                row.style.transform = 'translateX(100%)';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Error processing request', 'error');
            if (button) {
                button.disabled = false;
                button.innerHTML = action === 'approve' ? '<i class="fas fa-shield-alt"></i>' : '<i class="fas fa-times"></i>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
        if (button) {
            button.disabled = false;
            button.innerHTML = action === 'approve' ? '<i class="fas fa-shield-alt"></i>' : '<i class="fas fa-times"></i>';
        }
    });
}

// Refresh table
function refreshTable() {
    location.reload();
}

// Toast notification function
function showToast(message, type = 'success') {
    let toastElement, toastMessage;
    
    if (type === 'error') {
        toastElement = document.getElementById('errorToast');
        toastMessage = document.getElementById('errorMessage');
    } else {
        toastElement = document.getElementById('successToast');
        toastMessage = document.getElementById('toastMessage');
    }
    
    toastMessage.textContent = message;
    const bsToast = new bootstrap.Toast(toastElement);
    bsToast.show();
}

// Clear modals on hide
document.addEventListener('DOMContentLoaded', function() {
    // Auto-hide toasts after 3 seconds
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(toast => {
        new bootstrap.Toast(toast, { delay: 3000 });
    });
    
    // Clear modals on hide
    const modals = ['approveModal', 'rejectModal', 'inquiryModal', 'editGatePassModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function() {
                // Clear inputs
                const inputs = this.querySelectorAll('textarea');
                inputs.forEach(input => input.value = '');
            });
        }
    });
});
</script>
{% endblock %}