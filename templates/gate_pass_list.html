{% extends "base.html" %}

{% block page_title %}
    {% if user_role == 'store_manager' %}
        All Approved Gate Passes & Store Requests (View Only)
    {% elif session.role == 'security' %}
        Security - Approved Gate Passes (View Only)
    {% else %}
        Gate Pass List
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="fw-bold text-primary">
                        {% if user_role == 'store_manager' %}
                            <i class="fas fa-passport me-2"></i>All Approved Gate Passes (View Only)
                        {% elif session.role == 'department_head' %}
                            <i class="fas fa-passport me-2"></i>My Department Gate Passes
                        {% elif session.role == 'security' %}
                            <i class="fas fa-passport me-2"></i>Security - Approved Gate Passes (View Only)
                        {% elif session.role == 'system_admin' %}
                            <i class="fas fa-passport me-2"></i>All Gate Passes (System)
                        {% else %}
                            <i class="fas fa-passport me-2"></i>My Gate Passes
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0">
                        {% if user_role == 'store_manager' %}
                            <i class="fas fa-info-circle me-2"></i>
                            View all approved gate passes from all departments (No approval required)
                        {% elif session.role == 'security' %}
                            <i class="fas fa-info-circle me-2"></i>
                            View all approved gate passes from all departments (No approval required)
                        {% elif session.role == 'department_head' %}
                            <i class="fas fa-info-circle me-2"></i>
                            View and manage gate passes from your department
                        {% elif session.role == 'system_admin' %}
                            <i class="fas fa-info-circle me-2"></i>
                            View and manage all gate passes in the system
                        {% else %}
                            <i class="fas fa-info-circle me-2"></i>
                            View your gate passes
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if session.role != 'security' and session.role != 'store_manager' %}
                    <a href="{{ url_for('gate_pass.create_gate_pass') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Create Gate Pass
                    </a>
                    {% endif %}
                    
                    {% if user_role == 'store_manager' %}
                    <a href="{{ url_for('gate_pass.create_store_request') }}" class="btn btn-success btn-lg ms-2">
                        <i class="fas fa-shopping-cart me-2"></i>New Store Request
                    </a>
                    <a href="{{ url_for('gate_pass.store_material_log') }}" class="btn btn-info btn-lg ms-2">
                        <i class="fas fa-exchange-alt me-2"></i>Material Log
                    </a>
                    {% endif %}
                    
                    {% if session.role == 'security' %}
                    <a href="{{ url_for('security_scan_page') }}" class="btn btn-success btn-lg ms-2">
                        <i class="fas fa-qrcode me-2"></i>Scan QR Code
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- For Store Managers: Store Requests Section -->
    {% if user_role == 'store_manager' and store_requests %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>My Store Requests
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Request Details</th>
                                    <th>Status</th>
                                    <th>Urgency</th>
                                    <th>Admin Response</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in store_requests %}
                                <tr>
                                    <td class="ps-4">
                                        <h6 class="fw-bold mb-1">{{ request.material_description[:80] }}{% if request.material_description|length > 80 %}...{% endif %}</h6>
                                        <small class="text-muted">To: {{ request.destination }}</small>
                                        <br>
                                        <small class="text-muted">Purpose: {{ request.purpose[:60] }}</small>
                                    </td>
                                    <td>
                                        {% if request.status == 'pending' %}
                                        <span class="badge bg-warning py-2 px-3">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                        {% elif request.status == 'approved' %}
                                        <span class="badge bg-success py-2 px-3">
                                            <i class="fas fa-check me-1"></i>Approved
                                        </span>
                                        {% elif request.status == 'rejected' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-times me-1"></i>Rejected
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info py-2 px-3">
                                            <i class="fas fa-cog me-1"></i>Processing
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if request.urgency == 'urgent' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Urgent
                                        </span>
                                        {% elif request.urgency == 'emergency' %}
                                        <span class="badge bg-danger py-2 px-3">
                                            <i class="fas fa-skull-crossbones me-1"></i>Emergency
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary py-2 px-3">
                                            <i class="fas fa-check me-1"></i>Normal
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if request.admin_response %}
                                        <small class="text-muted">{{ request.admin_response[:80] }}</small>
                                        {% if request.admin_response|length > 80 %}...{% endif %}
                                        {% else %}
                                        <small class="text-muted">Waiting for response...</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ request.created_at.strftime('%d/%m/%Y') }}</small>
                                        <br>
                                        <small class="text-muted">{{ request.created_at.strftime('%I:%M %p') }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gate Passes Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-primary">
                    <i class="fas fa-list me-2"></i>
                    {% if user_role == 'store_manager' %}
                        Approved Gate Passes (View Only)
                    {% elif session.role == 'security' %}
                        Approved Gate Passes (View Only)
                    {% else %}
                        Gate Passes
                    {% endif %}
                    {% if user_role == 'store_manager' %}
                        (All Departments)
                    {% elif session.role == 'security' %}
                        (All Departments)
                    {% endif %}
                </h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshTable()" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <span class="badge bg-primary rounded-pill px-3 py-2">
                        {{ gate_passes|length }} passes
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if gate_passes %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Gate Pass Details</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Approved By</th>
                            <th>Created</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pass in gate_passes %}
                        <tr>
                            <td class="ps-4">
                                <div>
                                    <h6 class="fw-bold mb-1 text-primary">
                                        <i class="fas fa-passport me-2"></i>{{ pass.pass_number }}
                                    </h6>
                                    <p class="mb-1 text-muted small">
                                        <i class="fas fa-box me-1"></i>
                                        {{ pass.material_description[:60] }}{% if pass.material_description|length > 60 %}...{% endif %}
                                    </p>
                                    <p class="mb-0 text-muted small">
                                        <i class="fas fa-user me-1"></i>By {{ pass.creator_name }}
                                    </p>
                                </div>
                            </td>
                            <td>
                                <div class="department-badge">
                                    <span class="badge bg-light text-dark border">
                                        <i class="fas fa-building me-1"></i>{{ pass.department_name }}
                                    </span>
                                    {% if pass.division_name %}
                                    <br>
                                    <small class="text-muted mt-1 d-block">
                                        <i class="fas fa-sitemap me-1"></i>{{ pass.division_name }}
                                    </small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if pass.status == 'approved' %}
                                <span class="badge bg-success py-2 px-3">
                                    <i class="fas fa-check-circle me-1"></i>Approved
                                </span>
                                {% if pass.department_approval_date %}
                                <br>
                                <small class="text-success mt-1 d-block">
                                    <i class="fas fa-calendar-check me-1"></i>{{ pass.department_approval_date.strftime('%d/%m %H:%M') }}
                                </small>
                                {% endif %}
                                {% elif pass.status == 'pending_dept' %}
                                <span class="badge bg-warning py-2 px-3">
                                    <i class="fas fa-clock me-1"></i>Pending Dept
                                </span>
                                {% elif pass.status == 'rejected' %}
                                <span class="badge bg-danger py-2 px-3">
                                    <i class="fas fa-times me-1"></i>Rejected
                                </span>
                                {% elif pass.status == 'inquiry' %}
                                <span class="badge bg-info py-2 px-3">
                                    <i class="fas fa-question-circle me-1"></i>Inquiry
                                </span>
                                {% else %}
                                <span class="badge bg-secondary py-2 px-3">
                                    <i class="fas fa-clock me-1"></i>{{ pass.status|replace('_', ' ')|title }}
                                </span>
                                {% endif %}
                                
                                <!-- Urgent status -->
                                {% if pass.urgent %}
                                <br>
                                <span class="badge bg-danger mt-1">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Urgent
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pass.department_approval == 'approved' %}
                                <small class="text-muted">Department Head</small>
                                <br>
                                <small class="text-muted">{{ pass.department_approval_date.strftime('%d/%m %H:%M') if pass.department_approval_date else '' }}</small>
                                {% else %}
                                <small class="text-muted">Not approved yet</small>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ pass.created_at.strftime('%d/%m/%Y') }}</small>
                                <br>
                                <small class="text-muted">{{ pass.created_at.strftime('%I:%M %p') }}</small>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('gate_pass.gate_pass_detail', gate_pass_id=pass.id) }}" 
                                       class="btn btn-outline-primary px-3"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    <!-- âœ… Security Print Button -->
                                    {% if session.role == 'security' and pass.status == 'approved' %}
                                    <a href="{{ url_for('security_print_gate_pass', gate_pass_id=pass.id) }}" 
                                       class="btn btn-outline-info px-3"
                                       title="Print Security Copy"
                                       target="_blank">
                                        <i class="fas fa-print"></i>
                                    </a>
                                    {% endif %}
                                    
                                    <!-- Store Manager: Mark as Dispatched -->
                                    {% if user_role == 'store_manager' and pass.status == 'approved' %}
                                    <button onclick="markDispatched({{ pass.id }})" 
                                            class="btn btn-outline-success px-3"
                                            title="Mark as Dispatched">
                                        <i class="fas fa-truck"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <!-- Department Head: Approve/Reject -->
                                    {% if session.role == 'department_head' and pass.department_approval == 'pending' %}
                                    <button onclick="approveGatePass({{ pass.id }}, 'approve')" 
                                            class="btn btn-outline-success px-3"
                                            title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button onclick="approveGatePass({{ pass.id }}, 'reject')" 
                                            class="btn btn-outline-danger px-3"
                                            title="Reject">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <!-- System Admin: Approve Gate Pass -->
                                    {% if session.role == 'system_admin' and pass.status == 'pending_security' %}
                                    <button onclick="approveGatePassAdmin({{ pass.id }})" 
                                            class="btn btn-success px-3"
                                            title="Approve as Admin">
                                        <i class="fas fa-shield-alt me-1"></i>Approve
                                    </button>
                                    {% endif %}
                                    
                                    <!-- Security: Mark as Returned -->
                                    {% if session.role == 'security' and pass.status == 'approved' and pass.material_type == 'returnable' and not pass.actual_return_date %}
                                    <button onclick="markReturned({{ pass.id }})" 
                                            class="btn btn-warning px-3"
                                            title="Mark as Returned">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <!-- Store Manager and Security: View Only Info -->
                                    {% if (user_role == 'store_manager' or session.role == 'security') and pass.status == 'approved' %}
                                    <a href="#" class="btn btn-outline-secondary px-3" title="View Only - No Approval Required">
                                        <i class="fas fa-info-circle"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="empty-state-icon mb-3">
                    <i class="fas fa-passport fa-4x text-primary opacity-25"></i>
                </div>
                <h5 class="fw-bold text-muted mb-2">No Gate Passes Found</h5>
                <p class="text-muted mb-0">
                    {% if session.role != 'security' and session.role != 'store_manager' and session.role != 'system_admin' and session.role != 'department_head' %}
                    Create your first gate pass to get started
                    {% elif session.role == 'security' %}
                    No approved gate passes available at the moment
                    {% elif user_role == 'store_manager' %}
                    No approved gate passes available at the moment
                    {% elif session.role == 'department_head' %}
                    No gate passes from your department
                    {% elif session.role == 'system_admin' %}
                    No gate passes in the system
                    {% else %}
                    No gate passes available at the moment
                    {% endif %}
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <div id="toastMessage">Operation completed successfully!</div>
        </div>
    </div>
    
    <div id="errorToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <div id="errorMessage">An error occurred!</div>
        </div>
    </div>
</div>

<style>
/* Custom Styles */
.card {
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.08);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px 12px 0 0 !important;
}

.table th {
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table th:nth-child(3) {
    min-width: 150px;
}

.table td {
    vertical-align: middle;
    padding: 1rem;
}

.badge {
    font-weight: 500;
    letter-spacing: 0.3px;
}

.empty-state-icon {
    opacity: 0.5;
}

.department-badge .badge {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.toast {
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.btn-group .btn {
    border-radius: 8px !important;
    margin: 2px;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 8px !important;
        margin: 2px 0;
    }
}
</style>

<script>
// Store Manager: Mark as Dispatched
function markDispatched(gatePassId) {
    if (!confirm('ðŸšš Mark this material as dispatched from store?')) return;
    
    showLoading('Marking as dispatched...');
    
    fetch(`/gate_pass/store/mark_dispatched/${gatePassId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Material marked as dispatched!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message || 'Error marking as dispatched', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
    });
}

// Department Head: Approve/Reject Gate Pass
function approveGatePass(passId, action) {
    const actionText = action === 'approve' ? 'Approve' : 'Reject';
    const icon = action === 'approve' ? 'âœ…' : 'âŒ';
    
    if (!confirm(`${icon} ${actionText} this gate pass?`)) return;
    
    showLoading('Processing request...');
    
    fetch(`/gate_pass/approve_gate_pass/${passId}/${action}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Gate pass processed successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message || 'Error processing request', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
    });
}

// System Admin: Approve Gate Pass
function approveGatePassAdmin(passId) {
    if (!confirm('âœ… Approve this gate pass as System Administrator?')) return;
    
    showLoading('Processing approval...');
    
    fetch(`/admin/approve_gate_pass/${passId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=approve&store_location=store_1'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Gate pass approved successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message || 'Error processing request', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
    });
}

// Security: Mark as Returned
function markReturned(passId) {
    if (!confirm('ðŸ“¦ Mark this returnable material as returned?')) return;
    
    showLoading('Marking as returned...');
    
    fetch(`/mark_returned/${passId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Material marked as returned!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message || 'Error marking as returned', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing request', 'error');
    });
}

// Refresh table
function refreshTable() {
    location.reload();
}

// Show loading indicator
function showLoading(message) {
    console.log('Loading:', message);
}

// Toast notification function
function showToast(message, type = 'success') {
    let toastElement, toastMessage;
    
    if (type === 'error') {
        toastElement = document.getElementById('errorToast');
        toastMessage = document.getElementById('errorMessage');
    } else {
        toastElement = document.getElementById('successToast');
        toastMessage = document.getElementById('toastMessage');
    }
    
    toastMessage.textContent = message;
    const bsToast = new bootstrap.Toast(toastElement);
    bsToast.show();
}

// Auto-hide toasts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(toast => {
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    });
});
</script>
{% endblock %}